<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>Thanh To√°n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/client-static/css/checkout.css}">
    <link rel="stylesheet" th:href="@{/client-static/css/stepper.css}">
    <link rel="stylesheet" th:href="@{/client-static/css/checkout-validation.css}">
</head>

<body class="checkout-page">

    <!-- Success Toast -->
    <div id="customSuccess" class="custom-toast success" style="display:none;">
        <i class="bi bi-check-circle-fill me-2"></i>
        <span id="successMsg"></span>
        <button class="close-btn" onclick="closeToast('customSuccess')">&times;</button>
        <div class="progress-bar"></div>
    </div>

    <!-- Error Toast -->
    <div id="customError" class="custom-toast error" style="display:none;">
        <i class="bi bi-x-circle-fill me-2"></i>
        <span id="errorMsg"></span>
        <button class="close-btn" onclick="closeToast('customError')">&times;</button>
        <div class="progress-bar"></div>
    </div>
    
    <div class="stepper-wrapper mb-4">
        <div class="progress" style="height: 2px;">
            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
        </div>
        <div class="stepper-items">
            <div class="stepper-item active">
                <div class="step-counter active">1</div>
                <div class="step-name">Thanh to√°n</div>
            </div>
            <div class="stepper-item ">
                <div class="step-counter">2</div>
                <div class="step-name">Ho√†n t·∫•t thanh to√°n</div>
            </div>
        </div>
    </div>

    <div class="container py-5">
        <div class="row g-4">
            <!-- Main Checkout Content -->
            <div class="col-lg-8">
                <!-- Cart Review Section -->
                <div class="checkout-step active" id="cart-review">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="mb-0">Gi·ªè h√†ng c·ªßa b·∫°n</h3>
                        <span class="badge bg-primary" th:text="${selectedItems.size()} + ' s·∫£n ph·∫©m'">S·∫£n ph·∫©m</span>
                    </div>
                    <!-- Products Table -->
                    <div class="row g-3">
                        <div class="col-md-6" th:each="item, iterStat : ${selectedItems}">
                            <div class="card hover-effect">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <div class="product-image-wrapper">
                                                <img th:src="@{${item.chiTietSp.sanPham.hinhAnhs[0].url}}"
                                                    class="img-fluid rounded" alt="Product">
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <h6 class="product-title mb-2" th:text="${item.chiTietSp.sanPham.ten}">T√™n
                                                s·∫£n ph·∫©m</h6>
                                            <div class="product-meta mb-2">
                                                <span class="badge bg-secondary me-2"
                                                    th:text="'Size: ' + ${item.chiTietSp.size.ten}">Size: M</span>
                                                <span class="badge bg-secondary"
                                                    th:text="${item.chiTietSp.mauSac.ten}">M√†u</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="price-info">
                                                    <small class="text-muted">Gi√°: <span
                                                            th:text="${#numbers.formatDecimal(item.chiTietSp.giaBan,0,'COMMA',0,'POINT')} + '‚Ç´'">0‚Ç´</span></small><br>
                                                    <small class="text-muted">SL: <span
                                                            th:text="${item.soLuong}">1</span></small>
                                                </div>
                                                <div class="total-price">
                                                    <strong class="text-danger"
                                                        th:text="${#numbers.formatDecimal(item.thanhTien,0,'COMMA',0,'POINT')} + '‚Ç´'">0‚Ç´</strong>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Information Form -->
                <div class="checkout-step" id="customer-info">
                    <h3 class="mb-4">üìã Th√¥ng Tin Ng∆∞·ªùi Nh·∫≠n</h3>
                    <form id="checkout-form" th:action="@{/gio-hang/thanh-toan/xac-nhan}" method="post"
                        class="needs-validation" novalidate>
                        <!-- Hidden inputs for form data -->
                        <th:block th:each="item : ${selectedItems}">
                            <input type="hidden" name="selectedId" th:value="${item.id}" />
                        </th:block>
                        <input type="hidden" name="tongTien" th:value="${tongTien}" />
                        <input type="hidden" id="loaiHoaDon" name="loaiHoaDon" value="Online" />
                        <input type="hidden" id="tienVanChuyenInput" name="tienVanChuyen" value="0" />
                        <input type="hidden" name="tenTinh" id="tenTinhHidden" />
                        <input type="hidden" name="tenHuyen" id="tenHuyenHidden" />
                        <input type="hidden" name="tenXa" id="tenXaHidden" />
                        <input type="hidden" name="tienGiam" id="tienGiamInput" value="0" />

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="tenNguoiNhan" name="tenNguoiNhan"
                                        th:value="${khachHang.ten}" placeholder="T√™n ng∆∞·ªùi nh·∫≠n" required>
                                    <label for="tenNguoiNhan">T√™n ng∆∞·ªùi nh·∫≠n <span class="text-danger">*</span></label>
                                </div>
                                <div class="invalid-feedback" id="tenNguoiNhan-error"></div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="tel" class="form-control" id="soDienThoai" name="soDienThoai"
                                        th:value="${khachHang.soDienThoai}" placeholder="S·ªë ƒëi·ªán tho·∫°i" required
                                        pattern="[0-9]{9,11}">
                                    <label for="soDienThoai">S·ªë ƒëi·ªán tho·∫°i <span class="text-danger">*</span></label>
                                </div>
                                <div class="invalid-feedback" id="soDienThoai-error"></div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="email" class="form-control" id="email" name="email"
                                        th:value="${khachHang.email}" placeholder="Email" required>
                                    <label for="email">Email <span class="text-danger">*</span></label>
                                </div>
                                <div class="invalid-feedback" id="email-error"></div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <textarea class="form-control" id="ghiChu" name="ghiChu" placeholder="Ghi ch√∫"
                                        style="height: 58px"></textarea>
                                    <label for="ghiChu">Ghi ch√∫</label>
                                </div>
                            </div>
                        </div>

                        <!-- Address Section -->
                        <h4 class="mt-4 mb-3">üìç ƒê·ªãa Ch·ªâ Giao H√†ng</h4>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <select name="provinceId" id="provinceSelect" class="form-select" required>
                                        <option value="">-- Ch·ªçn T·ªânh / Th√†nh ph·ªë --</option>
                                        <option th:each="province : ${provinces}"
                                            th:value="${province.get('ProvinceID')}"
                                            th:text="${province.get('ProvinceName')}"></option>
                                    </select>
                                    <label>T·ªânh / Th√†nh ph·ªë <span class="text-danger">*</span></label>
                                </div>
                                <div class="invalid-feedback" id="provinceSelect-error"></div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <select name="districtId" id="districtSelect" class="form-select" required>
                                        <option value="">-- Ch·ªçn Qu·∫≠n / Huy·ªán --</option>
                                        <option th:each="district : ${districts}" th:value="${district['DistrictID']}"
                                            th:text="${district['DistrictName']}"></option>
                                    </select>
                                    <label>Qu·∫≠n / Huy·ªán <span class="text-danger">*</span></label>
                                </div>
                                <div class="invalid-feedback" id="districtSelect-error"></div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <select name="wardId" id="wardSelect" class="form-select" required>
                                        <option value="">-- Ch·ªçn Ph∆∞·ªùng / X√£ --</option>
                                        <option th:each="ward : ${wards}" th:value="${ward.get('WardCode')}"
                                            th:text="${ward.get('WardName')}"></option>
                                    </select>
                                    <label>Ph∆∞·ªùng / X√£ <span class="text-danger">*</span></label>
                                </div>
                                <div class="invalid-feedback" id="wardSelect-error"></div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="diaChi" name="diaChi"
                                        placeholder="ƒê·ªãa ch·ªâ chi ti·∫øt" required>
                                    <label for="diaChi">ƒê·ªãa ch·ªâ chi ti·∫øt <span class="text-danger">*</span></label>
                                </div>
                                <div class="invalid-feedback" id="diaChi-error"></div>
                            </div>
                        </div>

                        <!-- Payment Method Section -->
                        <h4 class="mt-4 mb-3">üí≥ Ph∆∞∆°ng Th·ª©c Thanh To√°n</h4>
                        <div class="payment-options">
                            <div class="card mb-3 payment-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="phuongThucThanhToan"
                                                id="pttt_cod" value="tien_mat" required>
                                            <label class="form-check-label" for="pttt_cod">
                                                <h6 class="mb-0">üíµ Ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng (COD)</h6>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-3 payment-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="phuongThucThanhToan"
                                                id="pttt_ck" value="chuyen_khoan">
                                            <label class="form-check-label" for="pttt_ck">
                                                <h6 class="mb-0">üè¶ Chuy·ªÉn kho·∫£n ng√¢n h√†ng</h6>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Order Summary Sidebar -->
            <div class="col-lg-4">
                <!-- Discount Code Card -->
                <div class="card mb-3" style="background-color: #f8f9fa; border: 1px solid #e9ecef;">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-tag-fill text-primary me-2"></i>
                                <span class="fw-medium">M√£ ∆∞u ƒë√£i</span>
                            </div>
                            <div class="position-relative">
                                <select id="phieuGiamGia" name="phieuGiamGia" class="form-select border-0"
                                    style="box-shadow: none;">
                                    <option th:each="phieu : ${danhSachPhieuGiamGia}" th:value="${phieu.ma}"
                                        th:selected="${phieuTotNhat != null and phieu.ma == phieuTotNhat.ma}"
                                        th:text="${phieu.ma + ' - '
                                                + (#numbers.formatDecimal(phieu.mucDo, 0, 'COMMA', 0, 'POINT'))
                                                + (phieu.loaiPhieuGiamGia == 1 ? '%' : 'ƒë')
                                                + (phieu.loaiPhieuGiamGia == 1
                                                    ? ' - gi·∫£m t·ªëi ƒëa: ' + #numbers.formatDecimal(phieu.giamToiDa, 0, 'COMMA', 0, 'POINT')
                                                    : '')
                                                + ' - SL: ' + #numbers.formatDecimal(phieu.soLuongTon, 0, 'COMMA', 0, 'POINT')
                                                +' - ƒêi·ªÅu ki·ªán: ' + #numbers.formatDecimal(phieu.dieuKien, 0, 'COMMA', 0, 'POINT')}" th:disabled="${tongTien < phieu.dieuKien}">
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Details Card -->
                <div class="card order-summary">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-check-circle-fill text-primary me-2"></i>
                            <h5 class="card-title mb-0">Chi ti·∫øt <span class="text-primary">ƒë∆°n h√†ng</span></h5>
                        </div>

                        <div class="summary-item d-flex justify-content-between mb-2">
                            <span>Gi√° tr·ªã ƒë∆°n h√†ng:</span>
                            <span class="amount" id="tongTienText"
                                th:text="${#numbers.formatDecimal(tongTien,0,'COMMA',0,'POINT')} + ' ‚Ç´'">0 ‚Ç´</span>
                        </div>
                        <div class="summary-item d-flex justify-content-between mb-2">
                            <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                            <span class="amount" id="tienVanChuyenText">0 ‚Ç´</span>
                        </div>

                        <hr class="summary-divider">

                        <div class="summary-total d-flex justify-content-between mb-3">
                            <div>
                                <strong>T·ªïng ti·ªÅn thanh to√°n</strong><br>
                                <small class="text-muted">(ƒê√£ bao g·ªìm thu·∫ø VAT)</small>
                            </div>
                            <strong class="total-amount" id="tongThanhToanText">0 ‚Ç´</strong>
                        </div>

                        <div class="text-danger small mb-4" id="savingsText">
                            Ti·∫øt ki·ªám <span id="tienGiamText">0 ‚Ç´</span>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" form="checkout-form" class="btn btn-secondary btn-lg text-white" id="submitBtn" disabled>
                                THANH TO√ÅN
                            </button>
                            <a th:href="@{/gio-hang/hien_thi}" class="btn btn-outline-secondary">
                                ‚Üê Quay l·∫°i gi·ªè h√†ng
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- External JavaScript Files -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/client-static/js/checkout-validation.js}"></script>
</body>

</html>