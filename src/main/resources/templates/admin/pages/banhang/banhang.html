<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout}">
<head>
    <meta charset="UTF-8">
    <title>B√°n H√†ng Tr·ª±c Ti·∫øp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 10px; margin-bottom: 20px; }
        .total { font-size: 1.2rem; font-weight: bold; color: #e74c3c; }
    </style>
</head>
<body>
<section layout:fragment="content">
    <div class="container-fluid mt-5">
        <div class="row">

            <h2 class="text-center mb-4">B√°n H√†ng Tr·ª±c Ti·∫øp</h2>

            <!-- Tabs Gi·ªè h√†ng -->


            <div class="col-md-6">
                <!-- Ch·ªçn s·∫£n ph·∫©m -->
                <div class="card p-3">
                    <form id="formThemGio" method="post" th:action="@{/admin/ban-hang/them-gio}">
                        <input type="hidden" name="cartKey" th:value="${cartKey}" />
                        <input type="hidden" name="idChiTietSp" id="idChiTietSp" />
                        <div class="row g-2">
                            <!-- T√¨m ki·∫øm s·∫£n ph·∫©m -->
                            <div class="col-md-6 position-relative">
                                <input type="text" class="form-control" id="timSanPham" placeholder="T√¨m theo t√™n s·∫£n ph·∫©m..." autocomplete="off" />
                                <div id="goiYSanPham" class="list-group position-absolute w-100 z-3" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                            <!-- Nh·∫≠p s·ªë l∆∞·ª£ng -->
                            <div class="col-md-2">
                                <input type="number" name="soLuong" class="form-control" value="1" min="1" required />
                            </div>
                            <!-- Modal Qu√©t M√£ -->
                            <div class="modal fade" id="scannerModal" tabindex="-1" aria-labelledby="scannerModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Qu√©t m√£ s·∫£n ph·∫©m</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div id="scanner" style="width: 100%; height: 400px;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-2">
                                <button type="button" class="btn btn-outline-secondary w-100" onclick="openScanner()">üì∑ Qu√©t m√£</button>
                            </div>
                            <div th:if="${error}" class="alert alert-danger" role="alert">
                                <p th:text="${error}"></p>
                            </div>

                            <!-- N√∫t th√™m v√†o gi·ªè -->
                            <!--                            <div class="col-md-2">-->
                            <!--                                <button type="submit" class="btn btn-primary w-100">Th√™m v√†o gi·ªè</button>-->
                            <!--                            </div>-->
                        </div>
                    </form>
                </div>


                <!-- Ch·ªçn chi ti·∫øt s·∫£n ph·∫©m -->
                <table class="table">
                    <thead>
                    <tr>
                        <th class="p-3">#</th>
                        <th class="p-3">M√£</th>
                        <th class="p-3">·∫¢nh</th>
                        <th class="p-3">T√™n S·∫£n ph·∫©m</th>
                        <th class="p-3">Gi√°</th>
                        <th class="p-3">H√†nh ƒë·ªông</th>
                    </tr>
                    </thead>
                    <tbody id="ketQuaTimSanPham">
<!--                    <tr th:each="sp, stat : ${dsSanPham}">-->
<!--                        <td class="p-3" th:text="${stat.index + 1}">1</td>-->
<!--                        <td class="p-3" th:text="${sp.ma}">SP001</td>-->
<!--                        <td class="p-3">-->
<!--                            <img th:src="@{'/uploads/' + ${sp.hinhAnhs[0].url}}" alt="·∫¢nh" class="w-12 h-12 object-cover rounded">-->
<!--                        </td>-->
<!--                        <td class="p-3" th:text="${sp.ten}">SP001</td>-->
<!--                    </tr>-->
                    </tbody>
                </table>

            </div>
            <!-- Gi·ªè h√†ng -->
            <div class="col-md-6">
                <ul class="nav nav-tabs mb-3">
                    <li class="nav-item d-flex align-items-center" th:each="key, iterStat : ${tatCaGio}">
                        <a class="nav-link d-flex align-items-center" th:classappend="${key == cartKey} ? 'active'"
                           th:href="@{/admin/ban-hang(cartKey=${key})}">
                            <span th:text="'Gi·ªè ' + ${iterStat.index + 1}">Gi·ªè</span>
                            <form th:action="@{/admin/ban-hang/xoa-gio}" method="post" class="ms-2 mb-0" style="display:inline;">
                                <input type="hidden" name="cartKey" th:value="${key}" />
                                <button type="submit" class="btn btn-sm btn-close" title="X√≥a gi·ªè n√†y" style="margin-left: 8px;"></button>
                            </form>

                        </a>
                        <!-- N√∫t X ƒë·ªÉ x√≥a gi·ªè -->

                    </li>

                    <!-- Th√™m m·ªõi n·∫øu ch∆∞a ƒë·ªß 10 gi·ªè -->
                    <li class="nav-item" th:if="${nextCartKey != null}">
                        <a class="nav-link text-success"
                           th:href="@{/admin/ban-hang(cartKey=${nextCartKey})}">
                            + Gi·ªè m·ªõi
                        </a>
                    </li>
                </ul>
                <div class="card p-3">
                    <h4>Gi·ªè h√†ng</h4>
                    <table class="table table-bordered">
                        <thead class="table-light">
                        <tr>
                            <th>S·∫£n ph·∫©m</th>
                            <th>Gi√°</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Th√†nh ti·ªÅn</th>
                            <th>H√†nh ƒê·ªông</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="item : ${gioHang}">
                            <td th:text="${item.tenCtsp}"></td>
                            <td th:text="${#numbers.formatDecimal(item.giaSauGiam, 0, 'POINT', 0, 'COMMA')} + ' ‚Ç´'"></td>
                            <td>
                                <form th:action="@{/admin/ban-hang/cap-nhat-so-luong}" method="post"
                                      onsubmit="return validateSoLuong(this)">
                                    <input type="hidden" name="idChiTietSp" th:value="${item.chiTietSanPham.id}" />
                                    <input type="hidden" name="cartKey" th:value="${cartKey}" />
                                    <input type="number" name="soLuong"
                                           th:value="${item.soLuong}"
                                           min="1"
                                           th:attr="max=${item.chiTietSanPham.soLuong}"
                                           class="form-control so-luong-input"
                                           onchange="this.form.submit()"
                                           required />
                                </form>
                            </td>

                            <td th:text="${#numbers.formatDecimal(item.giaSauGiam * item.soLuong, 0, 'POINT', 0, 'COMMA')} + ' ‚Ç´'"></td>
                            <td>
                                <form th:action="@{/admin/ban-hang/xoa-san-pham}" method="post" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh√¥ng?');">
                                    <input type="hidden" name="cartKey" th:value="${cartKey}" />
                                    <input type="hidden" name="idChiTietSp" th:value="${item.chiTietSanPham.id}" />
                                    <button type="submit" class="btn btn-sm btn-danger">X√≥a</button>
                                </form>
                            </td>
                        </tr>
                        <tr th:if="${gioHang.isEmpty()}">
                            <td colspan="4" class="text-center text-muted">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</td>
                        </tr>
                        </tbody>
                    </table>


                    <p>T·ªïng ti·ªÅn: <span class="total" th:text="${#numbers.formatDecimal(tongTien, 0, 'POINT', 0, 'COMMA')} + ' ‚Ç´'"></span></p>
                    <form method="post" th:action="@{/admin/ban-hang/xoa-gio}">
                        <input type="hidden" name="cartKey" th:value="${cartKey}" />
                        <button class="btn btn-danger">X√≥a gi·ªè h√†ng</button>
                    </form>
                </div>

                <!-- M√£ gi·∫£m gi√° -->
                <div class="card p-3">
                    <form method="post" th:action="@{/admin/ban-hang/ap-dung-ma}">
                        <input type="hidden" name="cartKey" th:value="${cartKey}" />
                        <div class="row g-2 mb-2">
                            <div class="col-md-6">
                                <select class="form-select" name="maGiamGia">
                                    <option value="">-- M√£ gi·∫£m gi√° --</option>
                                    <option th:each="p : ${dsPhieuGiamGia}"
                                            th:value="${p.ma}"
                                            th:text="${p.ma + '-' + (#numbers.formatDecimal(p.mucDo, 0, 'COMMA', 0, 'POINT'))
                                            + (p.loaiPhieuGiamGia == 1 ? '%' : 'ƒë') + ' - gi·∫£m t·ªëi ƒëa:'
                                            + (#numbers.formatDecimal(p.giamToiDa, 0, 'COMMA', 0, 'POINT')) + ' /ƒêK: '
                                            + p.dieuKien}">
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-secondary" type="submit">√Åp d·ª•ng m√£</button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Thanh to√°n -->
                <div class="card p-3">
                    <form method="post" th:action="@{/admin/ban-hang/thanh-toan}" onsubmit="updateDiaChiHienThi()">
                        <input type="hidden" name="giagiam" th:value="${giamGia}" />
                        <input type="hidden" name="diaChiTinh" id="hiddenTinh">
                        <input type="hidden" name="diaChiHuyen" id="hiddenHuyen">
                        <input type="hidden" name="diaChiXa" id="hiddenXa">

                        <!-- Checkbox ƒë·ªÉ b·∫≠t/t·∫Øt t√≠nh nƒÉng v·∫≠n chuy·ªÉn -->
                        <div class="form-check my-3">
                            <input class="form-check-input" type="checkbox" id="muonVanChuyen">
                            <label class="form-check-label fw-bold" for="muonVanChuyen">
                                üöö T√¥i mu·ªën giao h√†ng t·ªõi ƒë·ªãa ch·ªâ
                            </label>
                        </div>

                        <!-- ƒê·ªãa ch·ªâ giao h√†ng -->
                        <div id="diaChiVanChuyen" style="display: none;">
                            <h5>ƒê·ªãa ch·ªâ giao h√†ng</h5>
                            <div class="row g-2 mb-3">
                                <div class="col-md-4"><select id="province" class="form-select" name="province"></select></div>
                                <div class="col-md-4"><select id="district" class="form-select" name="district"></select></div>
                                <div class="col-md-4"><select id="ward" class="form-select" name="ward"></select></div>
                            </div>

                            <div class="mb-3">
                                <label for="ten" class="form-label">T√™n ng∆∞·ªùi nh·∫≠n:</label>
                                <input type="text" name="ten" class="form-control" id="ten" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n">
                            </div>
                            <div class="mb-3">
                                <label for="soDienThoai" class="form-label">S·ªë ƒëi·ªán tho·∫°i:</label>
                                <input type="text" name="soDienThoai" class="form-control" id="soDienThoai" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                            </div>

                            <div class="mb-3">
                                <label for="ghichu" class="form-label">Ghi ch√∫:</label>
                                <input type="text" name="ghichu" class="form-control" id="ghichu" placeholder="Nh·∫≠p ghi ch√∫">
                            </div>
                            <!-- N√∫t t·∫°o ƒë∆°n v·∫≠n chuy·ªÉn -->

                        </div>

                        <div th:if="${maGiamGia != null}">
                            <p>M√£ gi·∫£m gi√° ƒë√£ √°p d·ª•ng: <strong th:text="${maGiamGia}"></strong></p>
                        </div>

                        <div>
                            <p>Ph√≠ v·∫≠n chuy·ªÉn: <strong id="shippingFee" th:text="${phiVanChuyen != null ? #numbers.formatDecimal(phiVanChuyen, 0, 'POINT', 0, 'COMMA') + ' ‚Ç´' : 'Ch∆∞a t√≠nh'}">Ch∆∞a t√≠nh</strong></p>
                            <p>T·ªïng ti·ªÅn: <span class="total" th:text="${#numbers.formatDecimal(tongTien, 0, 'POINT', 0, 'COMMA')} + ' ‚Ç´'"></span></p>
                            <p th:if="${giamGia != null and giamGia > 0}">
                                Gi·∫£m gi√°: <span class="total" th:text="${#numbers.formatDecimal(giamGia, 0, 'POINT', 0, 'COMMA')} + ' ‚Ç´'"></span>
                            </p>
                            <p>Th√†nh ti·ªÅn sau gi·∫£m: <span class="total" id="tongTien" th:text="${#numbers.formatDecimal(tongTienSauGiam, 0, 'POINT', 0, 'COMMA')} + ' ‚Ç´'"></span></p>
                        </div>

                        <div class="d-flex justify-content-between align-items-start mb-3 flex-wrap">
                            <!-- C·ªôt tr√°i: ph∆∞∆°ng th·ª©c thanh to√°n -->
                            <div class="me-4">
                                <label class="form-label fw-bold">Ph∆∞∆°ng th·ª©c thanh to√°n <span class="text-danger">*</span></label>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="phuongThucThanhToan" id="pttt_cod" value="tien_mat" required onchange="toggleQrImage()">
                                    <label class="form-check-label" for="pttt_cod">üíµ Ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng (COD)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="phuongThucThanhToan" id="pttt_ck" value="chuyen_khoan" onchange="toggleQrImage()">
                                    <label class="form-check-label" for="pttt_ck">üè¶ Chuy·ªÉn kho·∫£n ng√¢n h√†ng</label>
                                </div>
                            </div>

                            <!-- C·ªôt ph·∫£i: ·∫£nh QR -->
                            <div id="qrChuyenKhoan" style="display: none;">
                                <div class="text-center">
                                    <p class="fw-bold mb-2">Qu√©t m√£ QR ƒë·ªÉ chuy·ªÉn kho·∫£n</p>
                                    <img src="/uploads/Qr.jpg" alt="QR chuy·ªÉn kho·∫£n"
                                         style="max-width: 150px;" class="img-fluid border rounded">
                                </div>
                            </div>
                        </div>

                        <input type="hidden" name="cartKey" th:value="${cartKey}" />
                        <button type="submit" class="btn btn-success w-100 mt-2" id="btnThanhToan">Thanh to√°n</button>
                    </form>
                    <!--                    <div class="mb-3">-->
                    <!--                        <button type="button" class="btn btn-outline-primary" id="btnTaoDonVanChuyen">üöÄ T·∫°o ƒë∆°n v·∫≠n chuy·ªÉn</button>-->
                    <!--                    </div>-->
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            const provinceSelect = document.getElementById("province");
            const districtSelect = document.getElementById("district");
            const wardSelect = document.getElementById("ward");
            const shippingFeeElement = document.getElementById("shippingFee");

            // H√†m g·ªçi API l·∫•y danh s√°ch t·ªânh/huy·ªán/x√£
            async function fetchData(url) {
                const response = await fetch(url);
                if (!response.ok) throw new Error("L·ªói khi fetch d·ªØ li·ªáu");
                return await response.json();
            }

            // Load t·ªânh khi v√†o trang
            const provinces = await fetchData("/admin/ban-hang/dia-chi/tinh");
            provinceSelect.innerHTML = '<option value="">-- Ch·ªçn t·ªânh --</option>';
            provinces.forEach(p => {
                provinceSelect.innerHTML += `<option value="${p.ProvinceID}">${p.ProvinceName}</option>`;
            });

            // Khi ch·ªçn t·ªânh ‚Üí load huy·ªán
            provinceSelect.addEventListener("change", async function () {
                const provinceId = this.value;
                districtSelect.innerHTML = '<option value="">-- Ch·ªçn huy·ªán --</option>';
                wardSelect.innerHTML = '<option value="">-- Ch·ªçn x√£ --</option>';
                shippingFeeElement.innerText = "Ch∆∞a t√≠nh";
                if (!provinceId) return;

                const districts = await fetchData(`/admin/ban-hang/dia-chi/huyen?provinceId=${provinceId}`);
                districts.forEach(d => {
                    districtSelect.innerHTML += `<option value="${d.DistrictID}">${d.DistrictName}</option>`;
                });
            });

            // Khi ch·ªçn huy·ªán ‚Üí load x√£
            districtSelect.addEventListener("change", async function () {
                const districtId = this.value;
                wardSelect.innerHTML = '<option value="">-- Ch·ªçn x√£ --</option>';
                shippingFeeElement.innerText = "Ch∆∞a t√≠nh";
                if (!districtId) return;

                const wards = await fetchData(`/admin/ban-hang/dia-chi/xa?districtId=${districtId}`);
                wards.forEach(w => {
                    wardSelect.innerHTML += `<option value="${w.WardCode}">${w.WardName}</option>`;
                });
            });

            // Khi ch·ªçn x√£ ‚Üí g·ªçi t√≠nh ph√≠ ship
            wardSelect.addEventListener("change", async function () {
                const districtId = districtSelect.value;
                const wardCode = this.value;
                if (!districtId || !wardCode) return;

                try {
                    const response = await fetch(`/admin/ban-hang/phi-ship?toDistrictId=${districtId}&wardCode=${wardCode}`);
                    const fee = await response.json();
                    shippingFeeElement.innerText = fee.toLocaleString("vi-VN") + " ‚Ç´";
                } catch (error) {
                    shippingFeeElement.innerText = "Kh√¥ng th·ªÉ t√≠nh ph√≠";
                    console.error("L·ªói khi t√≠nh ph√≠ v·∫≠n chuy·ªÉn:", error);
                }
            });
        });

        function updateDiaChiHienThi() {
            document.getElementById("hiddenTinh").value = document.getElementById("province").options[document.getElementById("province").selectedIndex].text;
            document.getElementById("hiddenHuyen").value = document.getElementById("district").options[document.getElementById("district").selectedIndex].text;
            document.getElementById("hiddenXa").value = document.getElementById("ward").options[document.getElementById("ward").selectedIndex].text;
        }
    </script>

    <!-- Script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

    <script>
        btnThemGioHang.addEventListener("click", () => {
            const idMau = chonMau.value;
            const idSize = chonSize.value;

            if (!idMau || !idSize || !idSanPhamDangChon) {
                alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß m√†u s·∫Øc v√† size!");
                return;
            }

            // G·ª≠i d·ªØ li·ªáu th√™m gi·ªè h√†ng (POST)
            fetch("/admin/ban-hang/them-gio", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    idSanPham: idSanPhamDangChon,
                    idMauSac: idMau,
                    idSize: idSize
                })
            })
                .then(res => res.text())
                .then(msg => alert(msg));
        });



        document.addEventListener("click", function (e) {
            if (!goiYBox.contains(e.target) && e.target !== timSanPham) {
                goiYBox.innerHTML = "";
            }
        });

        function openScanner() {
            const modal = new bootstrap.Modal(document.getElementById("scannerModal"));
            modal.show();

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner'),
                    constraints: {
                        width: 640,
                        height: 400,
                        facingMode: "environment" // camera sau
                    }
                },
                decoder: {
                    readers: ["ean_reader", "code_128_reader", "upc_reader", "ean_8_reader", "code_39_reader"]
                }
            }, function (err) {
                if (err) {
                    console.error("Quagga init error:", err);
                    return;
                }
                Quagga.start();
            });
            Quagga.onDetected(function (result) {
                const code = result.codeResult.code;
                Quagga.offDetected();
                Quagga.stop();
                modal.hide();

                fetch(`/admin/ban-hang/tim-kiem-theo-ma-vach?maVach=${code}`)
                    .then(response => response.json())
                    .then(sp => {
                        if (sp && sp.tenSanPham) {
                            timSanPham.value = `${sp.tenSanPham} - ${sp.mauSac} / ${sp.size} - SL: ${sp.soluong} - Gi√°: ${sp.gia}`;
                            document.getElementById("idChiTietSp").value = sp.idChiTietSp;
                        } else {
                            timSanPham.value = `Kh√¥ng t√¨m th·∫•y m√£ v·∫°ch: ${code}`;
                        }
                    })
                    .catch(error => {
                        console.error("L·ªói khi t√¨m s·∫£n ph·∫©m:", error);
                        timSanPham.value = "L·ªói k·∫øt n·ªëi khi t√¨m s·∫£n ph·∫©m.";
                    });
            });
            Quagga.onDetected(function (result) {
                const code = result.codeResult.code;
                Quagga.offDetected();
                Quagga.stop();
                modal.hide();

                fetch(`/admin/ban-hang/tim-kiem-theo-ma-vach?maVach=${code}`)
                    .then(response => response.json())
                    .then(sp => {
                        if (sp && sp.tenSanPham) {
                            timSanPham.value = `${sp.tenSanPham} - ${sp.mauSac} / ${sp.size} - SL: ${sp.soluong} - Gi√°: ${sp.gia}`;
                            document.getElementById("idChiTietSp").value = sp.idChiTietSp;
                            const form = document.getElementById("formThemGio"); // g√°n id cho form c·ªßa b·∫°n
                            if (form) {
                                form.submit();
                            }
                        } else {
                            timSanPham.value = `Kh√¥ng t√¨m th·∫•y m√£ v·∫°ch: ${code}`;
                        }
                    })
                    .catch(error => {
                        console.error("L·ªói khi t√¨m s·∫£n ph·∫©m:", error);
                        timSanPham.value = "L·ªói k·∫øt n·ªëi khi t√¨m s·∫£n ph·∫©m.";
                    });
            });

        }
    </script>
    <script>
        const timSanPham = document.getElementById("timSanPham");
        const ketQuaBang = document.getElementById("ketQuaTimSanPham");
        const idChiTietSpInput = document.getElementById("idChiTietSp");

        timSanPham.addEventListener("input", function () {
            const keyword = this.value.trim();

            const url = keyword.length < 2
                ? `/admin/ban-hang/tim-kiem-san-pham`
                : `/admin/ban-hang/tim-kiem-san-pham?keyword=${encodeURIComponent(keyword)}`;

            fetch(url)
                .then(res => res.json())
                .then(dsSp => {
                    // L·ªçc b·ªè s·∫£n ph·∫©m c√≥ s·ªë l∆∞·ª£ng = 0
                    const spHienThi = dsSp.filter(sp => sp.soLuong > 0);

                    if (!spHienThi || spHienThi.length === 0) {
                        ketQuaBang.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-muted">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o</td>
                        </tr>`;
                        return;
                    }

                    ketQuaBang.innerHTML = spHienThi.map((sp, index) => `
                    <tr onclick="chonSanPham('${sp.id}', '${sp.tenSanPham} - ${sp.mauSac} / ${sp.kichThuoc} - SL: ${sp.soLuong}')">
                        <td class="p-3">${index + 1}</td>
                        <td class="p-3">${sp.ma || ''}</td>
                        <td class="p-3">
                            <img src="${'/uploads/' + sp.hinhAnh}" alt="·∫¢nh" class="w-12 h-12 object-cover rounded">
                        </td>
                        <td class="p-3">${sp.tenSanPham} - ${sp.mauSac} / ${sp.kichThuoc} - SL: ${sp.soLuong}</td>
                        <td class="p-3">${sp.giaBan}</td>
                        <td class="p-3">
                            <button class="btn btn-primary btn-them-gio"
                                    onclick="themVaoGioHang('${sp.id}')">
                                Th√™m v√†o gi·ªè
                            </button>
                        </td>
                    </tr>
                `).join('');
                })
                .catch(err => {
                    console.error(err);
                    ketQuaBang.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-danger">L·ªói khi t√¨m ki·∫øm s·∫£n ph·∫©m</td>
                    </tr>`;
                });
        });

        function chonSanPham(id, text) {
            document.getElementById("timSanPham").value = text;
            idChiTietSpInput.value = id;
        }

        function themVaoGioHang(idChiTietSp) {
            const csrfToken = document.querySelector('input[name="_csrf"]')?.value;

            // L·∫•y cartKey t·ª´ th·∫ª input hidden (v√≠ d·ª•)
            const cartKey = document.querySelector('input[name="cartKey"]')?.value;

            if (!cartKey) {
                alert("‚ùå Thi·∫øu cartKey!");
                return;
            }

            const payload = {
                idChiTietSp: idChiTietSp,
                soLuong: 1,
                cartKey: cartKey
            };

            fetch('/admin/ban-hang/them-gio-hang', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(csrfToken && { 'X-CSRF-TOKEN': csrfToken })
                },
                body: JSON.stringify(payload)
            })
                .then(res => {
                    if (res.ok) return res.text();
                    return res.text().then(text => { throw new Error(text); });
                })
                .then(data => {
                    alert("‚úÖ ƒê√£ th√™m v√†o gi·ªè h√†ng");
                    window.location.reload();
                    // C√≥ th·ªÉ c·∫≠p nh·∫≠t giao di·ªán gi·ªè h√†ng t·∫°i ƒë√¢y
                })
                .catch(err => {
                    console.error("L·ªói khi th√™m s·∫£n ph·∫©m:", err);
                    alert("‚ùå Kh√¥ng th·ªÉ th√™m s·∫£n ph·∫©m v√†o gi·ªè: " + err.message);
                });
        }

        function validateSoLuong(form) {
            const input = form.querySelector('input[name="soLuong"]');
            const soLuongMoi = parseInt(input.value);
            const soLuongTon = parseInt(input.dataset.ton);

            if (soLuongMoi > soLuongTon) {
                alert("‚ùå S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho: " + soLuongTon);
                return false;
            }
            return true;
        }
        function toggleQrImage() {
            const ckRadio = document.getElementById('pttt_ck');
            const qrDiv = document.getElementById('qrChuyenKhoan');
            if (ckRadio.checked) {
                qrDiv.style.display = 'block';
            } else {
                qrDiv.style.display = 'none';
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            toggleQrImage();
        });
        document.addEventListener("DOMContentLoaded", function () {
            const checkbox = document.getElementById("muonVanChuyen");
            const diaChiDiv = document.getElementById("diaChiVanChuyen");

            checkbox.addEventListener("change", function () {
                if (this.checked) {
                    diaChiDiv.style.display = "block";
                    calculateShipping();
                } else {
                    diaChiDiv.style.display = "none";
                }
            });

            document.getElementById("btnTaoDonVanChuyen").addEventListener("click", function () {
                // TODO: G·ªçi API t·∫°o ƒë∆°n v·∫≠n chuy·ªÉn t·∫°i ƒë√¢y (GHN ho·∫∑c GHTK)
                alert("ƒê√£ g·ª≠i y√™u c·∫ßu t·∫°o ƒë∆°n v·∫≠n chuy·ªÉn!");
            });
        });
    </script>

    <script>
        document.getElementById("btnThanhToan").addEventListener("click", function(event) {
            let tinh = document.getElementById("province").selectedOptions[0]?.text || "";
            let huyen = document.getElementById("district").selectedOptions[0]?.text || "";
            let xa = document.getElementById("ward").selectedOptions[0]?.text || "";

            let diaChi = `${xa}, ${huyen}, ${tinh}`;
            let tongTien = document.getElementById("tongTien")?.innerText || "0";

            let xacNhan = confirm(`X√°c nh·∫≠n thanh to√°n\nT·ªïng ti·ªÅn: ${tongTien}`);
            if (!xacNhan) {
                event.preventDefault(); // NgƒÉn form submit n·∫øu b·∫•m H·ªßy
            }
        });
    </script>

</section>
</body>
</html>