<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout}">
<head>
    <meta charset="UTF-8">
    <title>B√°n H√†ng Tr·ª±c Ti·∫øp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 10px; margin-bottom: 20px; }
        .total { font-size: 1.2rem; font-weight: bold; color: #e74c3c; }
    </style>
</head>
<body>
<section layout:fragment="content">
    <div class="container mt-4">

        <h2 class="text-center mb-4">B√°n H√†ng Tr·ª±c Ti·∫øp</h2>

        <!-- Tabs Gi·ªè h√†ng -->
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item" th:each="key, iterStat : ${tatCaGio}">
                <a class="nav-link" th:classappend="${key == cartKey} ? 'active'" th:href="@{/admin/ban-hang(cartKey=${key})}">
                    <span th:text="'Gi·ªè ' + ${iterStat.index + 1}">Gi·ªè</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-success"
                   th:href="@{/admin/ban-hang(cartKey='gio-' + ${tatCaGio.size() + 1})}">
                    + Gi·ªè m·ªõi
                </a>
            </li>
        </ul>

        <!-- Ch·ªçn s·∫£n ph·∫©m -->
        <div class="card p-3">
            <form id="formThemGio" method="post" th:action="@{/admin/ban-hang/them-gio}">
                <input type="hidden" name="cartKey" th:value="${cartKey}" />
                <input type="hidden" name="idChiTietSp" id="idChiTietSp" />
                <div class="row g-2">
                    <!-- T√¨m ki·∫øm s·∫£n ph·∫©m -->
                    <div class="col-md-6 position-relative">
                        <input type="text" class="form-control" id="timSanPham" placeholder="T√¨m theo t√™n s·∫£n ph·∫©m..." autocomplete="off" />
                        <div id="goiYSanPham" class="list-group position-absolute w-100 z-3" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    <!-- Nh·∫≠p s·ªë l∆∞·ª£ng -->
                    <div class="col-md-2">
                        <input type="number" name="soLuong" class="form-control" value="1" min="1" required />
                    </div>
                    <!-- Modal Qu√©t M√£ -->
                    <div class="modal fade" id="scannerModal" tabindex="-1" aria-labelledby="scannerModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Qu√©t m√£ s·∫£n ph·∫©m</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div id="scanner" style="width: 100%; height: 400px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-secondary w-100" onclick="openScanner()">üì∑ Qu√©t m√£</button>
                    </div>
                    <div th:if="${error}" class="alert alert-danger" role="alert">
                        <p th:text="${error}"></p>
                    </div>

                    <!-- N√∫t th√™m v√†o gi·ªè -->
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Th√™m v√†o gi·ªè</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Ch·ªçn chi ti·∫øt s·∫£n ph·∫©m -->
        <div class="card p-3" th:if="${dsChiTietSanPham != null and !dsChiTietSanPham.isEmpty()}">
            <form method="post" th:action="@{/admin/ban-hang/them-gio}">
                <input type="hidden" name="cartKey" th:value="${cartKey}" />
                <div class="row g-2">
                    <div class="col-md-6">
                        <select class="form-select" name="idChiTietSp" required>
                            <option value="">-- Ch·ªçn m√†u / size --</option>
                            <option th:each="ct : ${dsChiTietSanPham}"
                                    th:if="${ct.soLuong > 0}"
                                    th:value="${ct.id}"
                                    th:text="${ct.mauSac.ten + ' / ' + ct.size.ten + ' - SL: ' + ct.soLuong + ' - Gi√°: ' + ct.giaBan}">
                            </option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="number" name="soLuong" class="form-control" min="1" value="1" required />
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100" type="submit">Th√™m v√†o gi·ªè</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Gi·ªè h√†ng -->
        <div class="card p-3">
            <h4>Gi·ªè h√†ng</h4>
            <table class="table table-bordered">
                <thead class="table-light">
                <tr>
                    <th>S·∫£n ph·∫©m</th>
                    <th>Gi√°</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>Th√†nh ti·ªÅn</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="item : ${gioHang}">
                    <td th:text="${item.tenCtsp}"></td>
                    <td th:text="${#numbers.formatDecimal(item.giaSauGiam, 0, 'POINT', 0, 'COMMA')} + ' ‚Ç´'"></td>
                    <td>
                        <form th:action="@{/admin/ban-hang/cap-nhat-so-luong}" method="post" class="d-flex align-items-center">
                            <input type="hidden" name="cartKey" th:value="${cartKey}" />
                            <input type="hidden" name="idChiTietSp" th:value="${item.chiTietSanPham.id}" />
                            <input type="number" name="soLuong" th:value="${item.soLuong}" min="1"
                                   class="form-control form-control-sm me-2" style="width: 80px;"
                                   oninput="this.form.submit()" />
                        </form>
                    </td>

                    <td th:text="${#numbers.formatDecimal(item.giaSauGiam * item.soLuong, 0, 'POINT', 0, 'COMMA')} + ' ‚Ç´'"></td>
                </tr>
                <tr th:if="${gioHang.isEmpty()}">
                    <td colspan="4" class="text-center text-muted">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</td>
                </tr>
                </tbody>
            </table>
            <p>T·ªïng ti·ªÅn: <span class="total" th:text="${#numbers.formatDecimal(tongTien, 0, 'POINT', 0, 'COMMA')} + ' ‚Ç´'"></span></p>
            <form method="post" th:action="@{/admin/ban-hang/xoa-gio}">
                <input type="hidden" name="cartKey" th:value="${cartKey}" />
                <button class="btn btn-danger">X√≥a gi·ªè h√†ng</button>
            </form>
        </div>

        <!-- M√£ gi·∫£m gi√° -->
        <div class="card p-3">
            <form method="post" th:action="@{/admin/ban-hang/ap-dung-ma}">
                <input type="hidden" name="cartKey" th:value="${cartKey}" />
                <div class="row g-2 mb-2">
                    <div class="col-md-6">
                        <select class="form-select" name="maGiamGia">
                            <option value="">-- M√£ gi·∫£m gi√° --</option>
                            <option th:each="p : ${dsPhieuGiamGia}" th:value="${p.ma}"
                                    th:text="${p.ma + '-' + (#numbers.formatDecimal(p.mucDo, 0, 'COMMA', 0, 'POINT')) + (p.loaiPhieuGiamGia == 1 ? '%' : 'ƒë') + ' - gi·∫£m t·ªëi ƒëa:' + (#numbers.formatDecimal(p.giamToiDa, 0, 'COMMA', 0, 'POINT'))}">
                            </option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-secondary" type="submit">√Åp d·ª•ng m√£</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Thanh to√°n -->
        <div class="card p-3">
            <form method="post" th:action="@{/admin/ban-hang/thanh-toan}" onsubmit="updateDiaChiHienThi()">
                <input type="hidden" name="giagiam" th:value="${giamGia}" />
                <input type="hidden" name="diaChiTinh" id="hiddenTinh">
                <input type="hidden" name="diaChiHuyen" id="hiddenHuyen">
                <input type="hidden" name="diaChiXa" id="hiddenXa">

                <h5>ƒê·ªãa ch·ªâ giao h√†ng</h5>
                <div class="row g-2">
                    <div class="col-md-4"><select id="province" class="form-select"></select></div>
                    <div class="col-md-4"><select id="district" class="form-select"></select></div>
                    <div class="col-md-4"><select id="ward" class="form-select"></select></div>
                </div>

                <div class="mb-2">
                    <label for="soDienThoai" class="form-label">S·ªë ƒëi·ªán tho·∫°i:</label>
                    <input type="text" name="soDienThoai" class="form-control" id="soDienThoai" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                </div>

                <div class="mb-2">
                    <label>ƒê·ªãa ch·ªâ nh·∫≠n h√†ng:</label>
                    <p id="hienThiDiaChi" class="form-control-plaintext text-primary fw-bold"></p>
                </div>

                <div th:if="${maGiamGia != null}">
                    <p>M√£ gi·∫£m gi√° ƒë√£ √°p d·ª•ng: <strong th:text="${maGiamGia}"></strong></p>
                </div>

                <div>
                    <p>Ph√≠ v·∫≠n chuy·ªÉn: <strong id="shippingFee" th:text="${#numbers.formatDecimal(phiVanChuyen, 0, 'POINT', 0, 'COMMA')} + ' ‚Ç´'"></strong></p>
                    <p>T·ªïng ti·ªÅn: <span class="total" th:text="${#numbers.formatDecimal(tongTien, 0, 'POINT', 0, 'COMMA')} + ' ‚Ç´'"></span></p>
                    <p th:if="${giamGia != null and giamGia > 0}">
                        Gi·∫£m gi√°: <span class="total" th:text="${#numbers.formatDecimal(giamGia, 0, 'POINT', 0, 'COMMA')} + ' ‚Ç´'"></span>
                    </p>
                    <p>Th√†nh ti·ªÅn sau gi·∫£m: <span class="total" id="tongTien" th:text="${#numbers.formatDecimal(tongTienSauGiam, 0, 'POINT', 0, 'COMMA')} + ' ‚Ç´'"></span></p>
                </div>

                <div class="mb-2">
                    <label class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n:</label>
                    <div class="form-check">
                        <input type="radio" name="phuongThucThanhToan" value="tien_mat" checked />
                        <label class="form-check-label" >Ti·ªÅn m·∫∑t</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" name="phuongThucThanhToan" value="vnpay" />
                        <label class="form-check-label">Chuy·ªÉn kho·∫£n</label>
                    </div>
                </div>

                <input type="hidden" name="cartKey" th:value="${cartKey}" />
                <button class="btn btn-success w-100 mt-2">Thanh to√°n</button>
            </form>
        </div>

    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
    <script th:inline="javascript">
        const formatCurrency = (vnd) => vnd.toLocaleString("vi-VN") + " ‚Ç´";

        async function loadProvinces() {
            const res = await fetch("/admin/ban-hang/dia-chi/tinh");
            const data = await res.json();
            const select = document.getElementById("province");
            select.innerHTML = '<option value="">-- Ch·ªçn T·ªânh/Th√†nh --</option>';
            data.forEach(p => select.add(new Option(p.ProvinceName, p.ProvinceID)));
        }

        async function loadDistricts() {
            const provinceId = document.getElementById("province").value;
            const res = await fetch("/admin/ban-hang/dia-chi/huyen?provinceId=" + provinceId);
            const data = await res.json();
            const select = document.getElementById("district");
            select.innerHTML = '<option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>';
            data.forEach(d => select.add(new Option(d.DistrictName, d.DistrictID)));
        }

        async function loadWards() {
            const districtId = document.getElementById("district").value;
            const res = await fetch("/admin/ban-hang/dia-chi/xa?districtId=" + districtId);
            const data = await res.json();
            const select = document.getElementById("ward");
            select.innerHTML = '<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>';
            data.forEach(w => select.add(new Option(w.WardName, w.WardCode)));
        }

        async function calculateShipping() {
            const districtId = document.getElementById("district").value;
            const wardCode = document.getElementById("ward").value;
            if (districtId && wardCode) {
                const res = await fetch(`/admin/ban-hang/phi-ship?toDistrictId=${districtId}&wardCode=${wardCode}`);
                const fee = await res.json();
                document.getElementById("shippingFee").innerText = formatCurrency(fee);
            }
        }

        function updateDiaChiHienThi() {
            const tinh = document.getElementById("province");
            const huyen = document.getElementById("district");
            const xa = document.getElementById("ward");

            const tenTinh = tinh.options[tinh.selectedIndex]?.text || "";
            const tenHuyen = huyen.options[huyen.selectedIndex]?.text || "";
            const tenXa = xa.options[xa.selectedIndex]?.text || "";

            document.getElementById("hiddenTinh").value = tenTinh;
            document.getElementById("hiddenHuyen").value = tenHuyen;
            document.getElementById("hiddenXa").value = tenXa;

            const full = [tenXa, tenHuyen, tenTinh].filter(Boolean).join(", ");
            document.getElementById("hienThiDiaChi").innerText = full;
        }

        function whenAddressChanges() {
            updateDiaChiHienThi();
            calculateShipping();
        }

        window.onload = function () {
            loadProvinces();
            document.getElementById("province").addEventListener("change", async function () {
                await loadDistricts();
                updateDiaChiHienThi();
            });
            document.getElementById("district").addEventListener("change", async function () {
                await loadWards();
                updateDiaChiHienThi();
            });
            document.getElementById("ward").addEventListener("change", whenAddressChanges);
        };
    </script>
    <!-- Script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script>
        const timSanPham = document.getElementById("timSanPham");
        const goiYBox = document.getElementById("goiYSanPham");

        timSanPham.addEventListener("input", function () {
            const keyword = this.value;
            if (keyword.length < 2) {
                goiYBox.innerHTML = "";
                return;
            }

            fetch(`/admin/ban-hang/tim-kiem-san-pham?keyword=${encodeURIComponent(keyword)}`)
                .then(res => res.json())
                .then(data => {
                    goiYBox.innerHTML = "";
                    data.forEach(sp => {
                        const item = document.createElement("button");
                        item.type = "button";
                        item.classList.add("list-group-item", "list-group-item-action");
                        item.textContent = `${sp.tenSanPham} - ${sp.mauSac} / ${sp.size}-SL:${sp.soluong}-Gia:${sp.gia}`;
                        item.addEventListener("click", () => {
                            timSanPham.value = item.textContent;
                            document.getElementById("idChiTietSp").value = sp.idChiTietSp;
                            goiYBox.innerHTML = "";
                        });
                        goiYBox.appendChild(item);
                    });
                });
        });

        document.addEventListener("click", function (e) {
            if (!goiYBox.contains(e.target) && e.target !== timSanPham) {
                goiYBox.innerHTML = "";
            }
        });

        function openScanner() {
            const modal = new bootstrap.Modal(document.getElementById("scannerModal"));
            modal.show();

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner'),
                    constraints: {
                        width: 640,
                        height: 400,
                        facingMode: "environment" // camera sau
                    }
                },
                decoder: {
                    readers: ["ean_reader", "code_128_reader", "upc_reader", "ean_8_reader", "code_39_reader"]
                }
            }, function (err) {
                if (err) {
                    console.error("Quagga init error:", err);
                    return;
                }
                Quagga.start();
            });
            Quagga.onDetected(function (result) {
                const code = result.codeResult.code;
                Quagga.offDetected();
                Quagga.stop();
                modal.hide();

                fetch(`/admin/ban-hang/tim-kiem-theo-ma-vach?maVach=${code}`)
                    .then(response => response.json())
                    .then(sp => {
                        if (sp && sp.tenSanPham) {
                            timSanPham.value = `${sp.tenSanPham} - ${sp.mauSac} / ${sp.size} - SL: ${sp.soluong} - Gi√°: ${sp.gia}`;
                            document.getElementById("idChiTietSp").value = sp.idChiTietSp;
                        } else {
                            timSanPham.value = `Kh√¥ng t√¨m th·∫•y m√£ v·∫°ch: ${code}`;
                        }
                    })
                    .catch(error => {
                        console.error("L·ªói khi t√¨m s·∫£n ph·∫©m:", error);
                        timSanPham.value = "L·ªói k·∫øt n·ªëi khi t√¨m s·∫£n ph·∫©m.";
                    });
            });
            Quagga.onDetected(function (result) {
                const code = result.codeResult.code;
                Quagga.offDetected();
                Quagga.stop();
                modal.hide();

                fetch(`/admin/ban-hang/tim-kiem-theo-ma-vach?maVach=${code}`)
                    .then(response => response.json())
                    .then(sp => {
                        if (sp && sp.tenSanPham) {
                            timSanPham.value = `${sp.tenSanPham} - ${sp.mauSac} / ${sp.size} - SL: ${sp.soluong} - Gi√°: ${sp.gia}`;
                            document.getElementById("idChiTietSp").value = sp.idChiTietSp;
                            const form = document.getElementById("formThemGio"); // g√°n id cho form c·ªßa b·∫°n
                            if (form) {
                                form.submit();
                            }
                        } else {
                            timSanPham.value = `Kh√¥ng t√¨m th·∫•y m√£ v·∫°ch: ${code}`;
                        }
                    })
                    .catch(error => {
                        console.error("L·ªói khi t√¨m s·∫£n ph·∫©m:", error);
                        timSanPham.value = "L·ªói k·∫øt n·ªëi khi t√¨m s·∫£n ph·∫©m.";
                    });
            });
            // Quagga.onDetected(function (result) {
            //     const code = result.codeResult.code;
            //     Quagga.offDetected(); // ch·ªâ b·∫Øt 1 l·∫ßn
            //     Quagga.stop();
            //     modal.hide();
            //
            //     // G√°n v√†o input v√† k√≠ch ho·∫°t event
            //     timSanPham.value = code;
            //     const inputEvent = new Event("input", { bubbles: true });
            //     timSanPham.dispatchEvent(inputEvent);
            // });
        }
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const btnMomo = document.getElementById("btnMomo");
            const momoForm = document.getElementById("momoForm");

            btnMomo?.addEventListener("click", function () {
                if (momoForm) {
                    momoForm.submit();
                } else {
                    alert("C√≥ l·ªói x·∫£y ra: Kh√¥ng t√¨m th·∫•y form thanh to√°n MoMo.");
                }
            });
        });
    </script>



</section>


</body>
</html>