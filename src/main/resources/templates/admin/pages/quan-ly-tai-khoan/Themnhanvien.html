
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout}">
<head>
    <meta charset="UTF-8">
    <title>Thêm nhân viên</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
<section layout:fragment="content" class="container my-5">

    <h2 class="text-center mb-4">Thêm Nhân Viên</h2>

    <form th:action="@{/admin/quanlytaikhoan/nhanvien/save}"
          th:object="${nhanvien}"
          method="post"
          enctype="multipart/form-data">
        <div class="row g-3">

            <!-- Mã nhân viên -->
            <div class="col-md-6 form-floating position-relative">
                <input type="text"
                       th:field="*{ma}"
                       id="ma"
                       class="form-control"
                       placeholder="NV001"
                       required
                       pattern="NV[0-9]{1,5}"
                       title="Mã phải bắt đầu NV + 1–5 chữ số">
                <label for="ma">Mã</label>
                <!-- luôn render, mặc định ẩn -->
                <div id="maError"
                     class="text-danger small mt-1 d-none">
                    <!-- nội dung sẽ được JS hoặc server fill vào -->
                    <span th:text="${maDuplicateError}"></span>
                </div>
            </div>



            <div class="col-md-6 form-floating">
                <input type="text" th:field="*{ten}" class="form-control" placeholder="Tên" required>
                <label>Tên</label>
            </div>

            <div class="col-md-6 form-floating">
                <input type="date" th:field="*{ngaySinh}" class="form-control" placeholder="Ngày sinh" required>
                <label>Ngày sinh</label>
            </div>

            <!-- Số điện thoại -->
            <div class="col-md-6 form-floating">
                <input type="text" th:field="*{soDienThoai}" class="form-control"
                       placeholder="Số điện thoại" required
                       pattern="^\d{9,12}$"
                       title="Số điện thoại phải có từ 9 đến 12 chữ số.">
                <label>Số điện thoại</label>
            </div>

            <input type="hidden" th:field="*{ngayThamGia}"/>

            <!-- CMND -->
            <div class="col-md-6 form-floating">
                <input type="text" th:field="*{chungMinhThu}" class="form-control"
                       placeholder="CMND" required
                       pattern="[0-9]{12}"
                       title="CMND phải gồm đúng 12 chữ số.">
                <label>CMND</label>
            </div>

            <div class="col-md-6 form-floating">
                <select th:field="*{gioiTinh}" class="form-select" required>
                    <option value="true">Nam</option>
                    <option value="false">Nữ</option>
                </select>
                <label>Giới tính</label>
            </div>

            <div class="col-md-6 form-floating">
                <input type="file" name="anhFile" class="form-control" id="anhFile">
                <label for="anhFile">Ảnh nhân viên</label>
            </div>

            <!-- Email -->
            <div class="col-md-6 form-floating">
                <input type="text" id="email" th:field="*{email}" class="form-control"
                       placeholder="you@gmail.com" required>
                <label for="email">Email</label>
                <div id="emailError" class="text-danger small mt-1 d-none"></div>
            </div>



            <div class="col-md-6 form-floating">
                <input th:type="${passwordVisible} ? 'text' : 'password'"
                       th:field="*{matKhau}" id="matKhauInput"
                       class="form-control" placeholder="Mật khẩu" required>
                <label for="matKhauInput">Mật khẩu</label>
                <button type="button"
                        class="btn btn-outline-secondary position-absolute top-50 end-0 translate-middle-y me-2 border-0"
                        style="z-index: 10"
                        onclick="togglePasswordVisibility()">
                    <i class="bi" id="eyeIcon"
                       th:classappend="${passwordVisible} ? 'bi-eye-slash' : 'bi-eye'"></i>
                </button>
            </div>

            <div class="col-md-6 form-floating">
                <select th:field="*{chucVu}" class="form-select" required>
                    <option value="0">Quản lý</option>
                    <option value="1">Nhân viên</option>
                </select>
                <label>Chức vụ</label>
            </div>

            <div class="col-md-6 form-floating">
                <select th:field="*{trangThai}" class="form-select" required>
                    <option value="true">Hoạt động</option>
                    <option value="false">Khoá</option>
                </select>
                <label>Trạng thái</label>
            </div>
        </div>

        <div class="mt-4 d-flex justify-content-between">
            <a th:href="@{/admin/quanlytaikhoan/nhanvien}" class="btn btn-secondary">Quay lại</a>
            <button type="submit" class="btn btn-primary">Lưu</button>
        </div>
    </form>
    <script>
        /*]]>*/
        function togglePasswordVisibility() {
            const input = document.getElementById("matKhauInput");
            const icon = document.getElementById("eyeIcon");

            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove("bi-eye");
                icon.classList.add("bi-eye-slash");
            } else {
                input.type = "password";
                icon.classList.remove("bi-eye-slash");
                icon.classList.add("bi-eye");
            }
        }
        document.addEventListener("DOMContentLoaded", function() {

            const maInput    = document.getElementById("ma");
            const errorDiv   = document.getElementById("maError");
            const submitBtn  = document.querySelector("button[type=submit]");

            function checkMaUnique() {
                const maVal = maInput.value.trim();
                if (!/^NV\d{1,5}$/.test(maVal)) {
                    errorDiv.classList.add("d-none");
                    submitBtn.disabled = false;
                    return;
                }
                fetch(`/admin/quanlytaikhoan/nhanvien/checkMa?ma=${encodeURIComponent(maVal)}`)
                    .then(resp => resp.json())
                    .then(exists => {
                        if (exists) {
                            errorDiv.textContent = "Mã NV đã tồn tại, vui lòng nhập mã khác.";
                            errorDiv.classList.remove("d-none");
                            submitBtn.disabled = true;
                        } else {
                            errorDiv.classList.add("d-none");
                            submitBtn.disabled = false;
                        }
                    })
                    .catch(() => {
                        // lỗi mạng: cho phép submit, server sẽ validate lần cuối
                        errorDiv.classList.add("d-none");
                        submitBtn.disabled = false;
                    });
            }

            maInput.addEventListener("blur", checkMaUnique);
            maInput.addEventListener("input", () => {
                errorDiv.classList.add("d-none");
                submitBtn.disabled = false;
            });
        });
    </script>

</section>

<<script>
    document.addEventListener("DOMContentLoaded", () => {
        const form      = document.getElementById("formNhanVien");
        const maInput   = document.getElementById("ma");
        const emailIn   = document.getElementById("email");
        const fileInput = document.getElementById("anhFile");
        const maErr     = document.getElementById("maError");
        const emailErr  = document.getElementById("emailError");
        const fileErr   = document.getElementById("fileError");

        function show(el, msg) {
            el.textContent = msg;
            el.classList.remove("d-none");
        }
        function hide(el) {
            el.textContent = "";
            el.classList.add("d-none");
        }

        form.addEventListener("submit", e => {
            let valid = true;
            hide(maErr); hide(emailErr); hide(fileErr);

            // --- 1) Mã NV phải NV + 1–5 số
            if (!/^NV[0-9]{1,5}$/.test(maInput.value.trim())) {
                show(maErr, "Mã phải bắt đầu NV + 1–5 chữ số");
                valid = false;
            }

            // --- 2) Email phải kết thúc @gmail.com
            if (!/^[A-Za-z0-9._%+-]+@gmail\.com$/.test(emailIn.value.trim())) {
                show(emailErr, "Email phải kết thúc bằng @gmail.com");
                valid = false;
            }

            // --- 3) Ảnh: nếu có, phải jpg/png/gif và ≤5MB
            if (fileInput.files.length > 0) {
                const f = fileInput.files[0];
                const ext = f.name.split(".").pop().toLowerCase();
                if (!["jpg","jpeg","png","gif"].includes(ext)) {
                    show(fileErr, "Chỉ chấp nhận JPG, PNG, GIF");
                    valid = false;
                } else if (f.size > 5 * 1024 * 1024) {
                    show(fileErr, "Kích thước phải ≤ 5MB");
                    valid = false;
                }
            }

            if (!valid) {
                e.preventDefault();
                // cuộn lại tới chỗ đầu tiên có lỗi nếu muốn:
                const firstErr = document.querySelector(".text-danger:not(.d-none)");
                firstErr && firstErr.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
    (function () {
        'use strict'
        const forms = document.querySelectorAll('.needs-validation')
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
    })()
</script>
</body>
</html>