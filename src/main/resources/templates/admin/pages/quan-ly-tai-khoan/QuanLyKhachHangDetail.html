<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${readonly}? 'Thông tin khách hàng' : 'Cập nhật khách hàng'"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* style cho nút toggle mắt */
        .toggle-password-btn {
            position: absolute;
            top: 50%;
            right: 0.75rem;
            transform: translateY(-50%);
            border: none;
            background: transparent;
            padding: 0;
            cursor: pointer;
            z-index: 10;
        }
    </style>
</head>
<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        const form   = document.querySelector('form');
        const fields = form.querySelectorAll('input[name], select[name]');
        const initialData = {};

        // Lưu giá trị ban đầu
        fields.forEach(field => {
            initialData[field.name] = field.value;
        });

        form.addEventListener('submit', function(event) {
            // Kiểm tra có thay đổi không
            let isChanged = false;
            fields.forEach(field => {
                if (field.value !== initialData[field.name]) {
                    isChanged = true;
                }
            });

            if (!isChanged) {
                // Chưa sửa gì → hủy submit, show alert
                event.preventDefault();
                alert('Bạn chưa sửa gì!');
                return;
            }

            // Nếu có sửa → đánh dấu để hiển thị alert thành công ở list page
            localStorage.setItem('khUpdated','true');
        });
    });
    /*]]>*/
</script>


<body class="bg-light">

<div class="container my-5">
    <h2 class="text-center mb-4"
        th:text="${readonly}? 'Thông tin khách hàng' : 'Cập nhật khách hàng'"></h2>

    <form th:action="@{/admin/quanlytaikhoan/khachhang/update}"
          th:object="${khachhang}"
          method="post">
        <input type="hidden" th:field="*{id}" />

        <div class="row g-3">
            <!-- Mã -->
            <div class="col-md-6 form-floating">
                <input type="text"
                       th:field="*{ma}"
                       class="form-control"
                       placeholder="Mã"
                       th:readonly="${readonly}"
                       required>
                <label>Mã</label>
                <div class="text-danger"
                     th:if="${#fields.hasErrors('ma')}"
                     th:errors="*{ma}"></div>
            </div>

            <!-- Tên -->
            <div class="col-md-6 form-floating">
                <input type="text"
                       th:field="*{ten}"
                       class="form-control"
                       placeholder="Tên"
                       th:readonly="${readonly}"
                       required>
                <label>Tên</label>
                <div class="text-danger"
                     th:if="${#fields.hasErrors('ten')}"
                     th:errors="*{ten}"></div>
            </div>

            <!-- Ngày sinh -->
            <div class="col-md-6 form-floating">
                <input type="date"
                       th:field="*{ngaySinh}"
                       class="form-control"
                       placeholder="Ngày sinh"
                       th:readonly="${readonly}"
                       required>
                <label>Ngày sinh</label>
                <div class="text-danger"
                     th:if="${#fields.hasErrors('ngaySinh')}"
                     th:errors="*{ngaySinh}"></div>
            </div>

            <!-- Số điện thoại -->
            <div class="col-md-6 form-floating">
                <input type="text"
                       th:field="*{soDienThoai}"
                       class="form-control"
                       placeholder="Số điện thoại"
                       th:readonly="${readonly}"
                       required>
                <label>Số điện thoại</label>
                <div class="text-danger"
                     th:if="${#fields.hasErrors('soDienThoai')}"
                     th:errors="*{soDienThoai}"></div>
            </div>

            <!-- Ngày tham gia -->
            <div class="col-md-6 form-floating">
                <input type="date"
                       th:field="*{ngayThamGia}"
                       class="form-control"
                       placeholder="Ngày tham gia"
                       th:readonly="${readonly}"
                       required>
                <label>Ngày tham gia</label>
                <div class="text-danger"
                     th:if="${#fields.hasErrors('ngayThamGia')}"
                     th:errors="*{ngayThamGia}"></div>
            </div>

            <!-- Giới tính -->
            <div class="col-md-6 form-floating">
                <select th:field="*{gioiTinh}"
                        class="form-select"
                        th:disabled="${readonly}"
                        required>
                    <option value="true">Nam</option>
                    <option value="false">Nữ</option>
                </select>
                <label>Giới tính</label>
                <div class="text-danger"
                     th:if="${#fields.hasErrors('gioiTinh')}"
                     th:errors="*{gioiTinh}"></div>
            </div>

            <!-- Email -->
            <div class="col-md-6 form-floating">
                <input type="email"
                       th:field="*{email}"
                       class="form-control"
                       placeholder="Email"
                       th:readonly="${readonly}"
                       required>
                <label>Email</label>
                <div class="text-danger"
                     th:if="${#fields.hasErrors('email')}"
                     th:errors="*{email}"></div>
            </div>

            <!-- Mật khẩu -->
            <div class="col-md-6 position-relative">
                <div class="form-floating">
                    <input th:field="*{matKhau}"
                           th:type="${passwordVisible} ? 'text' : (readonly? 'text':'password')"
                           class="form-control"
                           id="matKhauInput"
                           placeholder="Mật khẩu"
                           th:readonly="${readonly}"
                           th:required="${!readonly}">
                    <label for="matKhauInput">Mật khẩu</label>
                </div>
                <!-- nút toggle mắt -->
                <button type="button"
                        class="btn btn-outline-secondary position-absolute top-50 end-0 translate-middle-y me-2 border-0"
                        style="z-index: 10"
                        onclick="togglePasswordVisibility()"
                        th:attr="disabled=${readonly}">
                    <i class="bi" id="eyeIcon"
                       th:classappend="${passwordVisible} ? 'bi-eye-slash' : 'bi-eye'"></i>
                </button>
                <div class="text-danger"
                     th:if="${#fields.hasErrors('matKhau')}"
                     th:errors="*{matKhau}"></div>
            </div>

            <!-- Trạng thái -->
            <div class="col-md-6 form-floating">
                <select th:field="*{trangThai}"
                        class="form-select"
                        th:disabled="${readonly}"
                        required>
                    <option value="true">Hoạt động</option>
                    <option value="false">Khoá</option>
                </select>
                <label>Trạng thái</label>
                <div class="text-danger"
                     th:if="${#fields.hasErrors('trangThai')}"
                     th:errors="*{trangThai}"></div>
            </div>
        </div>

        <div class="mt-4 d-flex justify-content-between">
            <a href="/admin/quanlytaikhoan/khachhang" class="btn btn-secondary">Quay lại</a>
            <button type="submit"
                    class="btn btn-primary"
                    th:if="${!readonly}"
            >
                Lưu
            </button>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    let passwordVisible = false;

    function togglePasswordVisibility() {
        const input = document.getElementById("matKhauInput");
        const icon  = document.getElementById("eyeIcon");
        passwordVisible = !passwordVisible;

        if (passwordVisible) {
            input.type = "text";
            icon.classList.replace("bi-eye", "bi-eye-slash");
        } else {
            // khi chuyển về ẩn, chỉ set type=password nếu đang ở chế độ sửa
            if (!/*[[${readonly}]]*/) {
                input.type = "password";
            }
            icon.classList.replace("bi-eye-slash", "bi-eye");
        }
    }
    /*]]>*/
</script>
</body>
</html>