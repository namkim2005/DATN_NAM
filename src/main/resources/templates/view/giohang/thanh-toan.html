<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Thanh To√°n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        .product-img {
            width: 60px;
            height: auto;
            border-radius: 6px;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4">üîí X√°c Nh·∫≠n Thanh To√°n</h2>

    <!-- B·∫£ng s·∫£n ph·∫©m kh√°ch h√†ng ch·ªçn -->
    <table class="table table-bordered align-middle">
        <thead class="table-dark">
        <tr>
            <th>#</th>
            <th>·∫¢nh</th>
            <th>T√™n s·∫£n ph·∫©m</th>
            <th>Size</th>
            <th>M√†u s·∫Øc</th>
            <th>Gi√°</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>Th√†nh ti·ªÅn</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="item, iterStat : ${selectedItems}">
            <td th:text="${iterStat.count}">1</td>
            <td><img th:src="@{${item.chiTietSp.sanPham.hinhAnhs[0].url}}" alt="·∫¢nh" class="product-img" /></td>
            <td th:text="${item.chiTietSp.sanPham.ten}">T√™n s·∫£n ph·∫©m</td>
            <td th:text="${item.chiTietSp.size.ten}">Size</td>
            <td th:text="${item.chiTietSp.mauSac.ten}">M√†u s·∫Øc</td>
            <td th:text="${#numbers.formatDecimal(item.chiTietSp.giaBan,0,'COMMA',0,'POINT')} + '‚Ç´'">0‚Ç´</td>
            <td th:text="${item.soLuong}">1</td>
            <td th:text="${#numbers.formatDecimal(item.thanhTien,0,'COMMA',0,'POINT')} + '‚Ç´'">0‚Ç´</td>
        </tr>
        </tbody>
    </table>

    <!-- T·ªïng ti·ªÅn -->
    <h4 class="text-end text-danger fw-bold mb-4">
        T·ªïng ti·ªÅn: <span th:text="${#numbers.formatDecimal(tongTien,0,'COMMA',0,'POINT')} + '‚Ç´'">0‚Ç´</span>
    </h4>

    <!-- Form nh·∫≠p th√¥ng tin thanh to√°n -->
    <form th:action="@{/gio-hang/thanh-toan/xac-nhan}" method="post">
        <th:block th:each="item : ${selectedItems}">
            <input type="hidden" name="selectedId" th:value="${item.id}" />
        </th:block>

        <input type="hidden" name="tongTien" th:value="${tongTien}" />

        <!-- B·∫°n c√≥ th·ªÉ th√™m nhi·ªÅu tr∆∞·ªùng kh√°ch h√†ng kh√°c n·∫øu c·∫ßn -->

        <div class="mb-3">
            <label for="tenNguoiNhan" class="form-label">T√™n ng∆∞·ªùi nh·∫≠n <span class="text-danger">*</span></label>
            <input type="text" id="tenNguoiNhan" th:value="${khachHang.ten}"  name="tenNguoiNhan" class="form-control" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n" required />
        </div>

        <div class="mb-3">
            <label for="soDienThoai" class="form-label">S·ªë ƒëi·ªán tho·∫°i <span class="text-danger">*</span></label>
            <input type="tel" id="soDienThoai" name="soDienThoai" th:value="${khachHang.soDienThoai}" class="form-control" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required pattern="[0-9]{9,11}" />
        </div>

        <div class="mb-3">
            <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
            <input type="email" id="email" name="email" th:value="${khachHang.email}" class="form-control" placeholder="Nh·∫≠p email" required />
        </div>

        <!--        <div class="mb-3">-->
        <!--            <label for="diaChi" class="form-label">ƒê·ªãa ch·ªâ nh·∫≠n h√†ng <span class="text-danger">*</span></label>-->
        <!--            <textarea id="diaChi" name="diaChi" rows="3" th:value="${khachHang.diaChi}" class="form-control" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ nh·∫≠n h√†ng" required></textarea>-->
        <!--        </div>-->

        <div class="mb-3">
            <label for="ghiChu" class="form-label">Ghi ch√∫ (tu·ª≥ ch·ªçn)</label>
            <textarea id="ghiChu" name="ghiChu" rows="2" class="form-control" placeholder="Ghi ch√∫ th√™m cho ƒë∆°n h√†ng"></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Ph∆∞∆°ng th·ª©c thanh to√°n <span class="text-danger">*</span></label>

            <div class="form-check">
                <input class="form-check-input" type="radio" name="phuongThucThanhToan" id="pttt_cod" value="tien_mat" required>
                <label class="form-check-label" for="pttt_cod">üíµ Ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng (COD)</label>
            </div>

            <div class="form-check">
                <input class="form-check-input" type="radio" name="phuongThucThanhToan" id="pttt_ck" value="chuyen_khoan">
                <label class="form-check-label" for="pttt_ck">üè¶ Chuy·ªÉn kho·∫£n ng√¢n h√†ng</label>
            </div>
        </div>

        <input type="hidden" id="loaiHoaDon" name="loaiHoaDon" value="Online" />


        <!-- Ph√≠ v·∫≠n chuy·ªÉn -->
        <input type="hidden" id="tienVanChuyenInput" name="tienVanChuyen" value="0" />

        <div class="mb-3">
            <label class="form-label">Ch·ªçn T·ªânh / Th√†nh ph·ªë</label>
            <select name="provinceId" id="provinceSelect" class="form-control">
                <option value="">-- Ch·ªçn T·ªânh / Th√†nh ph·ªë --</option>
                <th:block th:each="province : ${provinces}">
                    <option th:value="${province.get('ProvinceID')}" th:text="${province.get('ProvinceName')}"></option>
                </th:block>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">Qu·∫≠n / Huy·ªán</label>
            <select name="districtId" id="districtSelect" class="form-select">
                <option value="">-- Ch·ªçn Qu·∫≠n / Huy·ªán --</option>
                <th:block th:if="${districts != null}">
                    <option th:each="district : ${districts}"
                            th:value="${district['DistrictID']}"
                            th:text="${district['DistrictName']}">
                    </option>
                </th:block>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">Ph∆∞·ªùng / X√£</label>
            <select id="wardSelect" name="wardId" class="form-select" >
                <option value="">-- Ch·ªçn Ph∆∞·ªùng / X√£ --</option>
                <th:block th:if="${wards != null}">
                    <option th:each="ward : ${wards}"
                            th:value="${ward.get('WardCode')}"
                            th:text="${ward.get('WardName')}">
                    </option>
                </th:block>
            </select>
        </div>

        <input type="hidden" name="tenTinh" id="tenTinhHidden" />
        <input type="hidden" name="tenHuyen" id="tenHuyenHidden" />
        <input type="hidden" name="tenXa" id="tenXaHidden" />
        <input type="hidden" name="tienGiam" id="tienGiamInput" value="0" />
        <!-- M√£ phi·∫øu gi·∫£m gi√° -->
        <div class="mb-3">
            <label for="phieuGiamGia" class="form-label">Ch·ªçn m√£ phi·∫øu gi·∫£m gi√°</label>
            <select id="phieuGiamGia" name="phieuGiamGia" class="form-select">
                <option value="">-- Kh√¥ng s·ª≠ d·ª•ng --</option>
                <option th:each="phieu : ${danhSachPhieuGiamGia}"
                        th:value="${phieu.ma}"
                        th:text="${phieu.ten + ' - Gi·∫£m ' + phieu.mucDo}">
                </option>
            </select>
        </div>
        <!-- T√≠nh to√°n chi ti·∫øt thanh to√°n -->
        <div class="mb-4">
            <div class="row">
                <div class="col-md-6 offset-md-6">
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>T·ªïng ti·ªÅn h√†ng:</span>
                            <strong th:text="${#numbers.formatDecimal(tongTien,0,'COMMA',0,'POINT')} + '‚Ç´'">0‚Ç´</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Gi·∫£m gi√°:</span>
                            <strong id="tienGiamText" th:text="${#numbers.formatDecimal(tienGiam,0,'COMMA',0,'POINT')} + '‚Ç´'">0‚Ç´</strong>
                        </li>

                        <li class="list-group-item d-flex justify-content-between">
                            <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                            <strong id="tienVanChuyenText" th:text="${#numbers.formatDecimal(shippingFee,0,'COMMA',0,'POINT')} + '‚Ç´'">0‚Ç´</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between bg-light">
                            <span class="fw-bold text-danger">Ti·ªÅn c·∫ßn thanh to√°n:</span>
                            <strong id="tongThanhToanText" class="text-danger fs-5" th:text="${tongThanhToan} + '‚Ç´'">0‚Ç´</strong>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-success btn-lg">‚úÖ X√°c nh·∫≠n thanh to√°n</button>
        <a th:href="@{/gio-hang/hien_thi}" class="btn btn-secondary ms-2">‚Üê Quay l·∫°i gi·ªè h√†ng</a>
    </form>

</div>
<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        // Khai b√°o ph·∫ßn t·ª≠
        const phieuGiamGia = document.getElementById("phieuGiamGia");
        const tienGiamText = document.getElementById("tienGiamText");
        const tongThanhToanText = document.getElementById("tongThanhToanText");
        const provinceSelect = document.querySelector('select[name="provinceId"]');
        const districtSelect = document.querySelector('select[name="districtId"]');
        const wardSelect = document.querySelector('select[name="wardId"]');
        const shippingFeeText = document.getElementById("tienVanChuyenText");
        const shippingFeeInput = document.getElementById("tienVanChuyenInput");

        // C√°c input hidden l∆∞u t√™n ƒë·ªãa ch·ªâ
        const tenTinhHidden = document.getElementById("tenTinhHidden");
        const tenHuyenHidden = document.getElementById("tenHuyenHidden");
        const tenXaHidden = document.getElementById("tenXaHidden");

        // T·ªïng ti·ªÅn g·ªëc t·ª´ server
        const tongTien = /*[[${tongTien}]]*/ 0;
        let currentDiscount = 0;
        let currentShippingFee = 0;

        function updateTotalPay() {
            const total = tongTien - currentDiscount + currentShippingFee;
            tongThanhToanText.innerText = total.toLocaleString('vi-VN') + "‚Ç´";
        }

        function clearSelect(select, placeholder = "-- Ch·ªçn --") {
            if (!select) return;
            select.innerHTML = `<option value="">${placeholder}</option>`;
        }

        function populateSelect(select, items, valueKey, textKey) {
            if (!select) return;
            clearSelect(select);
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueKey];
                option.textContent = item[textKey];
                select.appendChild(option);
            });
        }

        // M√£ gi·∫£m gi√°
        phieuGiamGia.addEventListener("change", function () {
            const maPhieu = this.value;
            if (!maPhieu) {
                currentDiscount = 0;
                tienGiamText.innerText = "0‚Ç´";
                document.getElementById("tienGiamInput").value = 0; // ‚úÖ G√°n l·∫°i
                updateTotalPay();
                return;
            }

            fetch(`/gio-hang/phieu-giam-gia/tien-giam?maPhieu=${maPhieu}&tongTien=${tongTien}`)
                .then(res => res.json())
                .then(tienGiam => {
                    currentDiscount = tienGiam;
                    tienGiamText.innerText = tienGiam.toLocaleString('vi-VN') + "‚Ç´";
                    document.getElementById("tienGiamInput").value = tienGiam; // ‚úÖ G√°n l·∫°i
                    updateTotalPay();
                })
                .catch(() => {
                    currentDiscount = 0;
                    tienGiamText.innerText = "0‚Ç´";
                    document.getElementById("tienGiamInput").value = 0; // ‚úÖ G√°n l·∫°i
                    updateTotalPay();
                });
        });


        // Khi ch·ªçn t·ªânh
        provinceSelect.addEventListener("change", function () {
            const provinceId = this.value;
            const selectedText = this.options[this.selectedIndex]?.text || "";
            tenTinhHidden.value = selectedText;

            clearSelect(districtSelect, "-- Ch·ªçn Qu·∫≠n / Huy·ªán --");
            clearSelect(wardSelect, "-- Ch·ªçn Ph∆∞·ªùng / X√£ --");
            tenHuyenHidden.value = "";
            tenXaHidden.value = "";

            currentShippingFee = 0;
            shippingFeeText.innerText = "0‚Ç´";
            shippingFeeInput.value = 0;
            updateTotalPay();

            if (!provinceId) return;

            fetch(`/gio-hang/thanh-toan/location?provinceId=${provinceId}`)
                .then(res => res.json())
                .then(districts => populateSelect(districtSelect, districts, 'DistrictID', 'DistrictName'))
                .catch(err => console.error('L·ªói l·∫•y districts:', err));
        });

        // Khi ch·ªçn qu·∫≠n/huy·ªán
        districtSelect.addEventListener("change", function () {
            const districtId = this.value;
            const selectedText = this.options[this.selectedIndex]?.text || "";
            tenHuyenHidden.value = selectedText;

            clearSelect(wardSelect, "-- Ch·ªçn Ph∆∞·ªùng / X√£ --");
            tenXaHidden.value = "";

            currentShippingFee = 0;
            shippingFeeText.innerText = "0‚Ç´";
            shippingFeeInput.value = 0;
            updateTotalPay();

            if (!districtId) return;

            fetch(`/gio-hang/thanh-toan/location?districtId=${districtId}`)
                .then(res => res.json())
                .then(wards => populateSelect(wardSelect, wards, 'WardCode', 'WardName'))
                .catch(err => console.error('L·ªói l·∫•y wards:', err));
        });

        // Khi ch·ªçn ph∆∞·ªùng/x√£
        wardSelect.addEventListener("change", function () {
            const wardCode = this.value;
            const selectedText = this.options[this.selectedIndex]?.text || "";
            tenXaHidden.value = selectedText;

            updateShippingFee();
        });

        function updateShippingFee() {
            const districtId = districtSelect?.value;
            const wardCode = wardSelect?.value;

            if (!districtId || !wardCode) {
                currentShippingFee = 0;
                shippingFeeText.innerText = "0‚Ç´";
                shippingFeeInput.value = 0;
                updateTotalPay();
                return;
            }

            fetch(`/gio-hang/thanh-toan/shipping-fee?districtId=${districtId}&wardCode=${wardCode}`)
                .then(res => {
                    if (!res.ok) throw new Error("Kh√¥ng th·ªÉ l·∫•y ph√≠ v·∫≠n chuy·ªÉn");
                    return res.json();
                })
                .then(fee => {
                    currentShippingFee = fee;
                    shippingFeeText.innerText = fee.toLocaleString('vi-VN') + "‚Ç´";
                    shippingFeeInput.value = fee;
                    updateTotalPay();
                })
                .catch(err => {
                    console.error("L·ªói t√≠nh ph√≠ ship:", err);
                    currentShippingFee = 0;
                    shippingFeeText.innerText = "Kh√¥ng th·ªÉ t√≠nh";
                    shippingFeeInput.value = 0;
                    updateTotalPay();
                });
        }

        // Kh·ªüi t·∫°o l·∫ßn ƒë·∫ßu
        tienGiamText.innerText = "0‚Ç´";
        shippingFeeText.innerText = "0‚Ç´";
        tongThanhToanText.innerText = tongTien.toLocaleString('vi-VN') + "‚Ç´";
    });
</script>





<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>