<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{client/layout}">

<head>
    <title>Giỏ hàng - D&C Fashions</title>
    
    <!-- Page-specific CSS -->
    <th:block layout:fragment="css">
        <style>
            /*CSS Thong bao*/
            .custom-toast {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 40px 12px 18px;
                border-radius: 6px;
                color: white;
                z-index: 9999;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
                min-width: 280px;
                animation: fadeIn 0.3s ease-in-out;
                overflow: hidden;
            }

            .custom-toast.success {
                background-color: #28a745;
            }

            .custom-toast.error {
                background-color: #dc3545;
            }

            .custom-toast .close-btn {
                position: absolute;
                top: 6px;
                right: 8px;
                background: transparent;
                border: none;
                color: white;
                font-size: 1.2rem;
                font-weight: bold;
                line-height: 1;
                cursor: pointer;
                padding: 0;
            }

            .custom-toast .progress-bar {
                position: absolute;
                bottom: 0;
                left: 0;
                height: 4px;
                background-color: rgba(255, 255, 255, 0.7);
                animation: progressBar 4s linear forwards;
            }

            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-20px); }
                to { opacity: 1; transform: translateY(0); }
            }

            @keyframes progressBar {
                from { width: 100%; }
                to { width: 0%; }
            }

            /* Scandinavian Minimalist Design */
            .cart-container {
                background: linear-gradient(135deg, #faf9f6 0%, #f5f5f0 100%);
                min-height: calc(100vh - 200px);
                padding: 2rem 0;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            }

            /* Wood Texture Background */
            .cart-container::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-image: 
                    radial-gradient(circle at 20% 80%, rgba(210, 180, 140, 0.03) 0%, transparent 50%),
                    radial-gradient(circle at 80% 20%, rgba(160, 120, 80, 0.03) 0%, transparent 50%);
                pointer-events: none;
            }

            .cart-header {
                text-align: center;
                margin-bottom: 2rem;
                position: relative;
                z-index: 1;
            }

            .cart-title {
                font-size: 2rem;
                font-weight: 300;
                color: #2c3e50;
                margin-bottom: 0.5rem;
                letter-spacing: -0.02em;
            }

            .cart-subtitle {
                color: #7f8c8d;
                font-size: 1rem;
                font-weight: 400;
                line-height: 1.5;
            }

            /* Select All Section */
            .select-all-section {
                background: rgba(255, 255, 255, 0.8);
                backdrop-filter: blur(10px);
                border-radius: 12px;
                padding: 1rem 1.5rem;
                margin-bottom: 1.5rem;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
                border: 1px solid rgba(255, 255, 255, 0.3);
                position: relative;
                z-index: 1;
            }

            .select-all-label {
                display: flex;
                align-items: center;
                gap: 1rem;
                cursor: pointer;
                font-size: 1rem;
                font-weight: 500;
                color: #34495e;
            }

            .select-all-checkbox {
                width: 1.25rem;
                height: 1.25rem;
                accent-color: #8b7355;
                border: 2px solid #d2b48c;
                border-radius: 4px;
                transition: all 0.2s ease;
            }

            .select-all-checkbox:checked {
                border-color: #8b7355;
            }

            /* Product Items - Flat Design */
            .product-card {
                background: transparent;
                border-radius: 0;
                padding: 1.5rem 0;
                margin-bottom: 0;
                box-shadow: none;
                border: none;
                transition: none;
                position: relative;
                z-index: 1;
            }

            .product-card:not(:last-child)::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 1px;
                background: #e8e0d0;
            }

            .product-card:hover {
                transform: none;
                box-shadow: none;
                border-color: transparent;
                background: rgba(248, 246, 240, 0.3);
            }

            .product-card-content {
                display: grid;
                grid-template-columns: auto auto 1fr auto auto auto auto;
                gap: 1.5rem;
                align-items: center;
                padding: 0 1rem;
            }

            /* Checkbox */
            .product-checkbox {
                width: 1.25rem;
                height: 1.25rem;
                accent-color: #8b7355;
                border: 2px solid #d2b48c;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .product-checkbox:checked {
                border-color: #8b7355;
            }

            /* Product Image */
            .product-image-container {
                width: 80px;
                height: 80px;
                border-radius: 8px;
                overflow: hidden;
                border: 1px solid #f0e6d2;
                background: #faf9f6;
                transition: all 0.2s ease;
            }

            .product-image-container:hover {
                border-color: #d2b48c;
                transform: none;
            }

            .product-image {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.2s ease;
            }

            .product-image:hover {
                transform: none;
            }

            /* Product Info */
            .product-info {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                min-width: 200px;
            }

            .product-name {
                font-size: 1rem;
                font-weight: 400;
                color: #2c3e50;
                line-height: 1.4;
                margin-bottom: 0.25rem;
                letter-spacing: -0.01em;
            }

            .product-variant {
                background: #f8f6f0;
                color: #8b7355;
                padding: 0.25rem 0.75rem;
                border-radius: 12px;
                font-size: 0.85rem;
                font-weight: 500;
                display: inline-block;
                width: fit-content;
                border: 1px solid #e8e0d0;
                transition: all 0.2s ease;
            }

            .product-variant:hover {
                background: #f0e6d2;
                border-color: #d2b48c;
            }

            /* Price Information */
            .price-info {
                text-align: center;
                min-width: 100px;
            }

            .original-price {
                color: #bdc3c7;
                text-decoration: line-through;
                font-size: 0.85rem;
                margin-bottom: 0.25rem;
                font-weight: 400;
            }

            .current-price {
                color: #e74c3c;
                font-size: 1.1rem;
                font-weight: 500;
                letter-spacing: -0.01em;
            }

            /* Quantity Controls */
            .quantity-controls {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                background: #f8f6f0;
                border-radius: 8px;
                padding: 0.5rem;
                border: 1px solid #e8e0d0;
                transition: all 0.2s ease;
                min-width: 100px;
                justify-content: center;
                position: relative;
            }

            .quantity-controls.loading {
                opacity: 0.6;
                pointer-events: none;
            }

            .quantity-controls.loading::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 16px;
                height: 16px;
                margin: -8px 0 0 -8px;
                border: 2px solid #8b7355;
                border-top: 2px solid transparent;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .quantity-controls:hover {
                border-color: #d2b48c;
                background: #f0e6d2;
            }

            .quantity-btn {
                width: 28px;
                height: 28px;
                border: none;
                background: white;
                border-radius: 6px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                font-weight: 500;
                color: #8b7355;
                transition: all 0.2s ease;
                border: 1px solid #e8e0d0;
                font-size: 1rem;
            }

            .quantity-btn:hover:not(:disabled) {
                background: #8b7355;
                color: white;
                transform: none;
                border-color: #8b7355;
            }

            .quantity-btn:disabled {
                opacity: 0.4;
                cursor: not-allowed;
            }

            .quantity-input {
                width: 40px;
                text-align: center;
                border: 1px solid #e8e0d0;
                border-radius: 6px;
                padding: 0.5rem;
                font-size: 0.9rem;
                font-weight: 500;
                color: #2c3e50;
                background: white;
                transition: all 0.2s ease;
            }

            .quantity-input:focus {
                outline: none;
                border-color: #8b7355;
                box-shadow: 0 0 0 2px rgba(139, 115, 85, 0.1);
            }

            /* Item Total */
            .item-total {
                text-align: center;
                min-width: 80px;
            }

            .total-price {
                color: #e74c3c;
                font-size: 1.1rem;
                font-weight: 500;
                letter-spacing: -0.01em;
            }

            /* Action Buttons */
            .action-buttons {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                min-width: 120px;
            }

            .action-btn {
                background: none;
                border: none;
                color: #7f8c8d;
                font-size: 0.8rem;
                font-weight: 500;
                cursor: pointer;
                padding: 0.5rem 0.75rem;
                border-radius: 6px;
                transition: all 0.2s ease;
                text-decoration: none;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                border: 1px solid transparent;
            }

            .action-btn:hover {
                background: #f8f6f0;
                color: #34495e;
                border-color: #e8e0d0;
            }

            .action-btn.delete {
                color: #e74c3c;
            }

            .action-btn.delete:hover {
                background: #fdf2f2;
                border-color: #fecaca;
            }

            .action-btn.similar {
                color: #8b7355;
            }

            .action-btn.similar:hover {
                background: #f8f6f0;
                border-color: #e8e0d0;
            }

            /* Cart Summary */
            .cart-summary {
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(10px);
                border-radius: 16px;
                padding: 2rem;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.04);
                border: 1px solid rgba(255, 255, 255, 0.4);
                margin-top: 2rem;
                position: relative;
                z-index: 1;
            }

            .summary-content {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 2rem;
            }

            .summary-left {
                display: flex;
                align-items: center;
                gap: 2rem;
            }

            .continue-shopping {
                color: #8b7355;
                text-decoration: none;
                font-weight: 500;
                transition: all 0.2s ease;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                border: 1px solid transparent;
            }

            .continue-shopping:hover {
                color: #6b5b47;
                background: #f8f6f0;
                border-color: #e8e0d0;
            }

            .selected-count {
                color: #7f8c8d;
                font-weight: 500;
                font-size: 0.9rem;
            }

            .summary-right {
                text-align: right;
            }

            .total-label {
                color: #7f8c8d;
                font-size: 1rem;
                font-weight: 500;
                margin-bottom: 0.5rem;
            }

            .total-amount {
                color: #2c3e50;
                font-size: 2rem;
                font-weight: 300;
                margin-bottom: 1rem;
                letter-spacing: -0.02em;
            }

            .checkout-btn {
                background: #8b7355;
                color: white;
                padding: 1rem 2rem;
                border: none;
                border-radius: 8px;
                font-weight: 500;
                font-size: 1rem;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(139, 115, 85, 0.2);
                letter-spacing: 0.01em;
            }

            .checkout-btn:hover:not(:disabled) {
                transform: translateY(-1px);
                box-shadow: 0 6px 16px rgba(139, 115, 85, 0.3);
                background: #6b5b47;
            }

            .checkout-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }

            /* Empty Cart */
            .empty-cart {
                text-align: center;
                padding: 4rem 2rem;
                color: #7f8c8d;
                position: relative;
                z-index: 1;
            }

            .empty-cart-icon {
                font-size: 4rem;
                margin-bottom: 1.5rem;
                color: #d2b48c;
                opacity: 0.6;
            }

            .empty-cart-title {
                font-size: 1.5rem;
                font-weight: 300;
                margin-bottom: 1rem;
                color: #2c3e50;
                letter-spacing: -0.01em;
            }

            .empty-cart-message {
                font-size: 1rem;
                margin-bottom: 2rem;
                line-height: 1.5;
                color: #7f8c8d;
            }

            /* Responsive Design */
            @media (max-width: 1200px) {
                .product-card-content {
                    grid-template-columns: auto auto 1fr auto auto;
                    gap: 1rem;
                }
                
                .price-info, .item-total {
                    display: none;
                }
            }

            @media (max-width: 768px) {
                .cart-container {
                    padding: 1rem 0;
                }
                
                .cart-title {
                    font-size: 1.5rem;
                }
                
                .product-card {
                    padding: 1rem 0;
                }
                
                .product-card-content {
                    grid-template-columns: 1fr;
                    gap: 1rem;
                    text-align: center;
                }
                
                .product-image-container {
                    width: 60px;
                    height: 60px;
                    margin: 0 auto;
                }
                
                .action-buttons {
                    flex-direction: row;
                    justify-content: center;
                }
                
                .summary-content {
                    flex-direction: column;
                    text-align: center;
                    gap: 1.5rem;
                }
                
                .select-all-section {
                    padding: 0.75rem 1rem;
                }
            }

            @media (max-width: 480px) {
                .cart-header {
                    margin-bottom: 1.5rem;
                }
                
                .cart-title {
                    font-size: 1.25rem;
                }
                
                .product-card {
                    padding: 0.75rem 0;
                }
                
                .quantity-controls {
                    flex-direction: column;
                    gap: 0.25rem;
                }
            }
        </style>
    </th:block>
</head>

<body>
    <div layout:fragment="content">
        <!-- Success Toast -->
        <div id="customSuccess" class="custom-toast success" style="display:none;">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span id="successMsg"></span>
            <button class="close-btn" onclick="closeToast('customSuccess')">&times;</button>
            <div class="progress-bar"></div>
        </div>

        <!-- Error Toast -->
        <div id="customError" class="custom-toast error" style="display:none;">
            <i class="bi bi-x-circle-fill me-2"></i>
            <span id="errorMsg"></span>
            <button class="close-btn" onclick="closeToast('customError')">&times;</button>
            <div class="progress-bar"></div>
        </div>

        <!-- Giỏ hàng -->
        <div class="cart-container">
            <div class="max-w-7xl mx-auto px-4">
                <!-- Header -->
                <div class="cart-header">
                    <h1 class="cart-title">🛒 Giỏ Hàng Của Bạn</h1>
                    <p class="cart-subtitle">Quản lý và thanh toán sản phẩm một cách dễ dàng</p>
                </div>

                <!-- Chọn tất cả -->
                <div class="select-all-section">
                    <label class="select-all-label">
                        <input type="checkbox" id="chonTatCa" class="select-all-checkbox">
                        <span>Chọn tất cả sản phẩm</span>
                    </label>
                </div>

                <!-- Danh sách sản phẩm -->
                <div th:if="${list != null and !list.isEmpty()}">
                    <div th:each="item, iterStat : ${list}" 
                         th:data-price="${item.chiTietSp.giaBan}"
                         th:data-item-id="${item.id}"
                         class="product-card">
                        <div class="product-card-content">
                            <!-- Checkbox -->
                            <input type="checkbox" class="product-checkbox item-checkbox" 
                                   name="selectedId" th:value="${item.id}" />
                            
                            <!-- Ảnh sản phẩm -->
                            <div class="product-image-container">
                                <img th:src="@{${item.chiTietSp.sanPham.hinhAnhs[0].url}}" 
                                     th:alt="${item.chiTietSp.sanPham.ten}"
                                     class="product-image" 
                                     onerror="this.src='/client-static/images/item1.jpg'" />
                            </div>
                            
                            <!-- Thông tin sản phẩm -->
                            <div class="product-info">
                                <h3 class="product-name" th:text="${item.chiTietSp.sanPham.ten}">Tên sản phẩm</h3>
                                <div class="product-variant" 
                                     th:text="${item.chiTietSp.mauSac.ten + ', ' + item.chiTietSp.size.ten}">
                                    Màu, Size
                                </div>
                            </div>
                            
                            <!-- Giá cả -->
                            <div class="price-info">
                                <div class="original-price" 
                                     th:text="${#numbers.formatDecimal(item.chiTietSp.giaGoc != null ? item.chiTietSp.giaGoc : item.chiTietSp.giaBan, 0, 'COMMA', 0, 'POINT') + '₫'}">
                                    ₫99.000
                                </div>
                                <div class="current-price" 
                                     th:text="${#numbers.formatDecimal(item.chiTietSp.giaBan, 0, 'COMMA', 0, 'POINT') + '₫'}">
                                    ₫97.000
                                </div>
                            </div>
                            
                            <!-- Điều chỉnh số lượng -->
                            <div class="quantity-controls">
                                <button th:onclick="'updateQuantity(' + ${item.id} + ', -1)'"
                                        th:disabled="${item.soLuong <= 1}"
                                        class="quantity-btn quantity-decrease">−</button>
                                <input type="number" th:value="${item.soLuong}"
                                       th:data-item-id="${item.id}"
                                       th:data-original-value="${item.soLuong}"
                                       class="quantity-input quantity-input-field"
                                       min="1" th:max="${item.chiTietSp.soLuong}" />
                                <button th:onclick="'updateQuantity(' + ${item.id} + ', 1)'"
                                        th:disabled="${item.soLuong >= item.chiTietSp.soLuong}"
                                        class="quantity-btn quantity-increase">+</button>
                            </div>
                            
                            <!-- Thành tiền -->
                            <div class="item-total">
                                <div class="total-price line-total" 
                                     th:text="${#numbers.formatDecimal(item.thanhTien, 0, 'COMMA', 0, 'POINT') + '₫'}">
                                    ₫97.000
                                </div>
                            </div>
                            
                            <!-- Nút hành động -->
                            <div class="action-buttons">
                                <button th:onclick="'removeItem(' + ${item.id} + ')'"
                                        class="action-btn delete">
                                    <i class="fas fa-trash"></i> Xóa
                                </button>
                                <button class="action-btn similar">
                                    <i class="fas fa-arrow-down"></i> Tìm sản phẩm tương tự
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Giỏ hàng trống -->
                <div th:if="${list == null or list.isEmpty()}" class="empty-cart">
                    <div class="empty-cart-icon">🛒</div>
                    <h2 class="empty-cart-title">Giỏ hàng trống</h2>
                    <p class="empty-cart-message">Bạn chưa có sản phẩm nào trong giỏ hàng</p>
                    <a th:href="@{/san-pham/danh-sach}" class="checkout-btn">
                        Tiếp tục mua sắm
                    </a>
                </div>

                <!-- Tổng tiền + nút thanh toán -->
                <div th:if="${list != null and !list.isEmpty()}" class="cart-summary">
                    <div class="summary-content">
                        <div class="summary-left">
                            <a th:href="@{/san-pham/danh-sach}" class="continue-shopping">
                                ← Tiếp tục mua sắm
                            </a>
                            <span class="selected-count">
                                <span id="selectedCount">0</span> sản phẩm được chọn
                            </span>
                        </div>
                        <div class="summary-right">
                            <div class="total-label">Tổng tiền:</div>
                            <div class="total-amount" id="totalTien">0₫</div>
                            <button id="submitThanhToan" disabled class="checkout-btn">
                                🔒 Thanh Toán
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            /*<![CDATA[*/
            console.log('=== THYMELEAF SCRIPT LOADED FOR CART ===');
            
            // Cart management class
            class CartManager {
                constructor() {
                    this.initializeEventListeners();
                    this.updateUI();
                    console.log('CartManager initialized');
                }

                initializeEventListeners() {
                    // Select all checkbox
                    const chonTatCa = document.getElementById("chonTatCa");
                    if (chonTatCa) {
                        chonTatCa.addEventListener("change", (e) => {
                            this.toggleAllItems(e.target.checked);
                        });
                    }

                    // Individual item checkboxes
                    document.querySelectorAll(".item-checkbox").forEach(cb => {
                        cb.addEventListener("change", () => {
                            this.updateSelectAllState();
                            this.updateUI();
                        });
                    });

                    // Quantity input changes - cập nhật để gọi API khi người dùng nhập tay
                    document.querySelectorAll(".quantity-input-field").forEach(input => {
                        input.addEventListener("change", (e) => {
                            this.handleQuantityInputChange(e.target);
                        });
                        
                        // Lưu giá trị ban đầu để có thể khôi phục nếu có lỗi
                        input.setAttribute('data-original-value', input.value);
                    });

                    // Checkout button
                    const checkoutBtn = document.getElementById("submitThanhToan");
                    if (checkoutBtn) {
                        checkoutBtn.addEventListener("click", (e) => {
                            e.preventDefault();
                            this.handleCheckout();
                        });
                    }
                }

                toggleAllItems(checked) {
                    document.querySelectorAll(".item-checkbox").forEach(cb => {
                        cb.checked = checked;
                    });
                    this.updateUI();
                }

                updateSelectAllState() {
                    const checkboxes = document.querySelectorAll(".item-checkbox");
                    const chonTatCa = document.getElementById("chonTatCa");
                    if (chonTatCa) {
                        chonTatCa.checked = [...checkboxes].every(c => c.checked);
                        chonTatCa.indeterminate = !chonTatCa.checked && [...checkboxes].some(c => c.checked);
                    }
                }

                updateUI() {
                    this.updateTotal();
                    this.updateSelectedCount();
                    this.updateCheckoutButton();
                }

                updateTotal() {
                    let total = 0;
                    document.querySelectorAll(".product-card").forEach(card => {
                        const checkbox = card.querySelector(".item-checkbox");
                        if (checkbox && checkbox.checked) {
                            const price = parseInt(card.getAttribute("data-price")) || 0;
                            const quantity = parseInt(card.querySelector(".quantity-input-field").value) || 1;
                            total += price * quantity;
                        }
                    });
                    
                    const totalElement = document.getElementById("totalTien");
                    if (totalElement) {
                        totalElement.textContent = this.formatMoney(total);
                    }
                }

                updateSelectedCount() {
                    const checked = document.querySelectorAll(".item-checkbox:checked");
                    const countElement = document.getElementById("selectedCount");
                    if (countElement) {
                        countElement.textContent = checked.length;
                    }
                }

                updateCheckoutButton() {
                    const checked = document.querySelectorAll(".item-checkbox:checked");
                    const checkoutBtn = document.getElementById("submitThanhToan");
                    if (checkoutBtn) {
                        checkoutBtn.disabled = checked.length === 0;
                    }
                }

                formatMoney(number) {
                    return new Intl.NumberFormat('vi-VN').format(number) + "₫";
                }

                handleQuantityInputChange(input) {
                    const itemId = input.getAttribute("data-item-id");
                    const newQuantity = parseInt(input.value);
                    
                    if (newQuantity < 1) {
                        input.value = 1;
                        return;
                    }

                    // Cập nhật giá trị ban đầu
                    input.setAttribute('data-original-value', input.value);

                    // Gọi API để cập nhật database
                    this.updateQuantityInDatabase(itemId, newQuantity);
                }

                updateQuantityInDatabase(itemId, newQuantity) {
                    // Hiển thị loading state
                    const input = document.querySelector(`input[data-item-id="${itemId}"]`);
                    const quantityControls = input ? input.closest('.quantity-controls') : null;
                    
                    if (input) {
                        input.disabled = true;
                        input.style.opacity = '0.6';
                    }
                    
                    if (quantityControls) {
                        quantityControls.classList.add('loading');
                    }

                    // Gọi API cập nhật
                    fetch(`/gio-hang/cap-nhat/${itemId}?action=update&newSoluong=${newQuantity}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            // Cập nhật thành công - refresh trang để lấy dữ liệu mới
                            window.location.reload();
                        } else {
                            // Có lỗi - khôi phục giá trị cũ
                            this.resetQuantityInput(input, quantityControls);
                            this.showToast('error', 'Không thể cập nhật số lượng. Vui lòng thử lại!');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating quantity:', error);
                        // Khôi phục giá trị cũ
                        this.resetQuantityInput(input, quantityControls);
                        this.showToast('error', 'Có lỗi xảy ra khi cập nhật số lượng!');
                    });
                }

                resetQuantityInput(input, quantityControls) {
                    if (input) {
                        input.value = parseInt(input.getAttribute('data-original-value')) || 1;
                        input.disabled = false;
                        input.style.opacity = '1';
                    }
                    
                    if (quantityControls) {
                        quantityControls.classList.remove('loading');
                    }
                }

                handleCheckout() {
                    const checked = document.querySelectorAll(".item-checkbox:checked");
                    if (checked.length === 0) {
                        this.showToast("error", "Vui lòng chọn ít nhất một sản phẩm để thanh toán!");
                        return;
                    }

                    const params = new URLSearchParams();
                    checked.forEach(cb => params.append("selectedId", cb.value));
                    const url = "/gio-hang/thanh-toan?" + params.toString();
                    window.location.href = url;
                }

                showToast(type, message) {
                    const toastId = type === 'success' ? 'customSuccess' : 'customError';
                    const toastEl = document.getElementById(toastId);
                    const msgEl = document.getElementById(type === 'success' ? 'successMsg' : 'errorMsg');
                    
                    if (toastEl && msgEl) {
                        msgEl.textContent = message;
                        toastEl.style.display = 'block';
                        
                        setTimeout(() => {
                            toastEl.style.display = 'none';
                        }, 4000);
                    }
                }
            }

            // Toast notification functions
            function showCustomToast(type, message) {
                const toastId = type === 'success' ? 'customSuccess' : 'customError';
                const toastEl = document.getElementById(toastId);
                const msgEl = document.getElementById(type === 'success' ? 'successMsg' : 'errorMsg');
                const progressBar = toastEl.querySelector('.progress-bar');

                if (toastEl && msgEl) {
                    msgEl.textContent = message;
                    toastEl.style.display = 'block';

                    // Reset animation
                    if (progressBar) {
                        progressBar.style.animation = 'none';
                        void progressBar.offsetWidth;
                        progressBar.style.animation = null;
                    }

                    setTimeout(() => {
                        toastEl.style.display = 'none';
                    }, 4000);
                }
            }

            function closeToast(toastId) {
                const toastEl = document.getElementById(toastId);
                if (toastEl) {
                    toastEl.style.display = 'none';
                }
            }

            // Global functions for onclick handlers
            function updateQuantity(itemId, change) {
                const input = document.querySelector(`input[data-item-id="${itemId}"]`);
                if (input) {
                    const currentValue = parseInt(input.value) || 1;
                    const newValue = Math.max(1, currentValue + change);
                    
                    // Cập nhật UI trước
                    input.value = newValue;
                    
                    // Sử dụng CartManager để cập nhật database
                    if (window.cartManager) {
                        window.cartManager.updateQuantityInDatabase(itemId, newValue);
                    }
                }
            }

            function removeItem(itemId) {
                if (confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
                    window.location.href = `/gio-hang/xoa/${itemId}`;
                }
            }

            // Initialize cart manager when DOM is loaded
            document.addEventListener("DOMContentLoaded", function() {
                console.log('=== CART PAGE DOM LOADED ===');
                
                // Initialize cart manager
                window.cartManager = new CartManager();
                
                // Show toast messages if any
                const successMsg = /*[[${success}]]*/ null;
                const errorMsg = /*[[${error}]]*/ null;
                
                console.log('Success message:', successMsg);
                console.log('Error message:', errorMsg);
                
                if (successMsg && successMsg !== null && successMsg !== "null") {
                    showCustomToast('success', successMsg);
                }
                if (errorMsg && errorMsg !== null && errorMsg !== "null") {
                    showCustomToast('error', errorMsg);
                }
                
                console.log('=== CART PAGE INITIALIZATION COMPLETE ===');
            });
            /*]]>*/
        </script>
    </th:block>
</body>
</html>