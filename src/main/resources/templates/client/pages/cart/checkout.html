<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>Thanh To√°n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/client-static/css/checkout.css}">
    <link rel="stylesheet" th:href="@{/client-static/css/stepper.css}">
    <style>
        .dropdown-menu {
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1050 !important;
            position: absolute !important;
        }

        .dropdown-menu .form-select {
            border: none;
            padding: 0.5rem;
        }

        .dropdown-menu .form-select:focus {
            box-shadow: none;
            border: none;
        }

        .text-primary {
            color: #0070f3 !important;
        }

        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }

        /* Form validation styles */
        .form-control.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        .form-control.is-invalid:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        /* Fix dropdown positioning */
        .dropdown {
            position: relative;
        }

        .order-summary {
            position: relative;
            z-index: 1;
        }

        /* Ensure dropdown appears above other elements */
        .dropdown-menu.show {
            z-index: 1050 !important;
            position: absolute !important;
        }

        /* Spacing for body when using bg-gray-50 */
        body.bg-gray-50 {
            margin: 12px;
        }

        @media (min-width: 768px) {
            body.bg-gray-50 {
                margin: 20px;
            }
        }
    </style>

</head>

<body class="bg-gray-50">

    <!-- Success Toast -->
    <div id="customSuccess" class="custom-toast success" style="display:none;">
        <i class="bi bi-check-circle-fill me-2"></i>
        <span id="successMsg"></span>
        <button class="close-btn" onclick="closeToast('customSuccess')">&times;</button>
        <div class="progress-bar"></div>
    </div>

    <!-- Error Toast -->
    <div id="customError" class="custom-toast error" style="display:none;">
        <i class="bi bi-x-circle-fill me-2"></i>
        <span id="errorMsg"></span>
        <button class="close-btn" onclick="closeToast('customError')">&times;</button>
        <div class="progress-bar"></div>
    </div>
    <div class="stepper-wrapper mb-4">
        <div class="progress" style="height: 2px;">
            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
        </div>
        <div class="stepper-items">
            <div class="stepper-item active">
                <div class="step-counter active">1</div>
                <div class="step-name">Thanh to√°n</div>
            </div>
            <div class="stepper-item ">
                <div class="step-counter">2</div>
                <div class="step-name">Ho√†n t·∫•t thanh to√°n</div>
            </div>
        </div>
    </div>

    <div class="container py-5">
        <div class="row g-4">
            <!-- Main Checkout Content -->
            <div class="col-lg-8">
                <!-- Cart Review Section -->
                <div class="checkout-step active" id="cart-review">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="mb-0">Gi·ªè h√†ng c·ªßa b·∫°n</h3>
                        <span class="badge bg-primary" th:text="${selectedItems.size()} + ' s·∫£n ph·∫©m'">S·∫£n ph·∫©m</span>
                    </div>
                    <!-- Products Table -->
                    <div class="row g-3">
                        <div class="col-md-6" th:each="item, iterStat : ${selectedItems}">
                            <div class="card hover-effect">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <div class="product-image-wrapper">
                                                <img th:src="@{${item.chiTietSp.sanPham.hinhAnhs[0].url}}"
                                                    class="img-fluid rounded" alt="Product">
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <h6 class="product-title mb-2" th:text="${item.chiTietSp.sanPham.ten}">T√™n
                                                s·∫£n ph·∫©m</h6>
                                            <div class="product-meta mb-2">
                                                <span class="badge bg-secondary me-2"
                                                    th:text="'Size: ' + ${item.chiTietSp.size.ten}">Size: M</span>
                                                <span class="badge bg-secondary"
                                                    th:text="${item.chiTietSp.mauSac.ten}">M√†u</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="price-info">
                                                    <small class="text-muted">Gi√°: <span
                                                            th:text="${#numbers.formatDecimal(item.chiTietSp.giaBan,0,'COMMA',0,'POINT')} + '‚Ç´'">0‚Ç´</span></small><br>
                                                    <small class="text-muted">SL: <span
                                                            th:text="${item.soLuong}">1</span></small>
                                                </div>
                                                <div class="total-price">
                                                    <strong class="text-danger"
                                                        th:text="${#numbers.formatDecimal(item.thanhTien,0,'COMMA',0,'POINT')} + '‚Ç´'">0‚Ç´</strong>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Information Form -->
                <div class="checkout-step" id="customer-info">
                    <h3 class="mb-4">üìã Th√¥ng Tin Ng∆∞·ªùi Nh·∫≠n</h3>
                    <form id="checkout-form" th:action="@{/gio-hang/thanh-toan/xac-nhan}" method="post"
                        class="needs-validation" novalidate>
                        <!-- Hidden inputs for form data -->
                        <th:block th:each="item : ${selectedItems}">
                            <input type="hidden" name="selectedId" th:value="${item.id}" />
                        </th:block>
                        <input type="hidden" name="tongTien" th:value="${tongTien}" />
                        <input type="hidden" id="loaiHoaDon" name="loaiHoaDon" value="Online" />
                        <input type="hidden" id="tienVanChuyenInput" name="tienVanChuyen" value="0" />
                        <input type="hidden" name="tenTinh" id="tenTinhHidden" />
                        <input type="hidden" name="tenHuyen" id="tenHuyenHidden" />
                        <input type="hidden" name="tenXa" id="tenXaHidden" />
                        <input type="hidden" name="tienGiam" id="tienGiamInput" value="0" />
                        <input type="hidden" name="phieuGiamGia" id="phieuGiamGiaHidden" />

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="tenNguoiNhan" name="tenNguoiNhan"
                                        th:value="${khachHang.ten}" placeholder="T√™n ng∆∞·ªùi nh·∫≠n" required>
                                    <label for="tenNguoiNhan">T√™n ng∆∞·ªùi nh·∫≠n <span class="text-danger">*</span></label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="tel" class="form-control" id="soDienThoai" name="soDienThoai"
                                        th:value="${khachHang.soDienThoai}" placeholder="S·ªë ƒëi·ªán tho·∫°i" required
                                        pattern="[0-9]{9,11}">
                                    <label for="soDienThoai">S·ªë ƒëi·ªán tho·∫°i <span class="text-danger">*</span></label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="email" class="form-control" id="email" name="email"
                                        th:value="${khachHang.email}" placeholder="Email" required>
                                    <label for="email">Email <span class="text-danger">*</span></label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <textarea class="form-control" id="ghiChu" name="ghiChu" placeholder="Ghi ch√∫"
                                        style="height: 58px"></textarea>
                                    <label for="ghiChu">Ghi ch√∫</label>
                                </div>
                            </div>
                        </div>

                        <!-- Address Section -->
                        <h4 class="mt-4 mb-3">üìç ƒê·ªãa Ch·ªâ Giao H√†ng</h4>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <select name="provinceId" id="provinceSelect" class="form-select">
                                        <option value="">-- Ch·ªçn T·ªânh / Th√†nh ph·ªë --</option>
                                        <option th:each="province : ${provinces}"
                                            th:value="${province.get('ProvinceID')}"
                                            th:text="${province.get('ProvinceName')}"></option>
                                    </select>
                                    <label>T·ªânh / Th√†nh ph·ªë</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <select name="districtId" id="districtSelect" class="form-select">
                                        <option value="">-- Ch·ªçn Qu·∫≠n / Huy·ªán --</option>
                                        <option th:each="district : ${districts}" th:value="${district['DistrictID']}"
                                            th:text="${district['DistrictName']}"></option>
                                    </select>
                                    <label>Qu·∫≠n / Huy·ªán</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <select name="wardId" id="wardSelect" class="form-select">
                                        <option value="">-- Ch·ªçn Ph∆∞·ªùng / X√£ --</option>
                                        <option th:each="ward : ${wards}" th:value="${ward.get('WardCode')}"
                                            th:text="${ward.get('WardName')}"></option>
                                    </select>
                                    <label>Ph∆∞·ªùng / X√£</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="diaChi" name="diaChi"
                                        placeholder="ƒê·ªãa ch·ªâ chi ti·∫øt">
                                    <label for="diaChi">ƒê·ªãa ch·ªâ chi ti·∫øt</label>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method Section -->
                        <h4 class="mt-4 mb-3">üí≥ Ph∆∞∆°ng Th·ª©c Thanh To√°n</h4>
                        <div class="payment-options">
                            <div class="card mb-3 payment-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="phuongThucThanhToan"
                                                id="pttt_cod" value="tien_mat" required>
                                            <label class="form-check-label" for="pttt_cod">
                                                <h6 class="mb-0">üíµ Ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng (COD)</h6>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-3 payment-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="phuongThucThanhToan"
                                                id="pttt_ck" value="chuyen_khoan">
                                            <label class="form-check-label" for="pttt_ck">
                                                <h6 class="mb-0">üè¶ Chuy·ªÉn kho·∫£n ng√¢n h√†ng</h6>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </form>
                </div>
            </div>

            <!-- Order Summary Sidebar -->
            <div class="col-lg-4">
                <!-- Discount Code Card -->
                <div class="card mb-3" style="background-color: #f8f9fa; border: 1px solid #e9ecef;">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-tag-fill text-primary me-2"></i>
                                <span class="fw-medium">M√£ ∆∞u ƒë√£i</span>
                            </div>
                            <div class="position-relative">
                                <select id="phieuGiamGia" name="phieuGiamGia" class="form-select border-0"
                                    style="box-shadow: none;">
                                    <option th:each="phieu : ${danhSachPhieuGiamGia}" th:value="${phieu.ma}"
                                        th:selected="${phieuTotNhat != null and phieu.ma == phieuTotNhat.ma}"
                                        th:text="${phieu.ma + ' - '
                                                + (#numbers.formatDecimal(phieu.mucDo, 0, 'COMMA', 0, 'POINT'))
                                                + (phieu.loaiPhieuGiamGia == 1 ? '%' : 'ƒë')
                                                + (phieu.loaiPhieuGiamGia == 1
                                                    ? ' - gi·∫£m t·ªëi ƒëa: ' + #numbers.formatDecimal(phieu.giamToiDa, 0, 'COMMA', 0, 'POINT')
                                                    : '')
                                                + ' - SL: ' + #numbers.formatDecimal(phieu.soLuongTon, 0, 'COMMA', 0, 'POINT')
                                                +' - ƒêi·ªÅu ki·ªán: ' + #numbers.formatDecimal(phieu.dieuKien, 0, 'COMMA', 0, 'POINT')}" th:disabled="${tongTien < phieu.dieuKien}">
                                    </option>
                                </select>
                                <div class="position-absolute top-100 start-0 mt-1 w-100" id="discountDropdown"
                                    style="display: none; z-index: 1050;">
                                    <div class="card border shadow-sm">
                                        <div class="card-body p-2">

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Details Card -->
                <div class="card order-summary">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-check-circle-fill text-primary me-2"></i>
                            <h5 class="card-title mb-0">Chi ti·∫øt <span class="text-primary">ƒë∆°n h√†ng</span></h5>
                        </div>

                        <div class="summary-item d-flex justify-content-between mb-2">
                            <span>Gi√° tr·ªã ƒë∆°n h√†ng:</span>
                            <span class="amount"
                                th:text="${#numbers.formatDecimal(tongTien,0,'COMMA',0,'POINT')} + ' ‚Ç´'">0 ‚Ç´</span>
                        </div>
                        <div class="summary-item d-flex justify-content-between mb-2">
                            <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                            <span class="amount" id="tienVanChuyenText"
                                th:text="${#numbers.formatDecimal(shippingFee,0,'COMMA',0,'POINT')} + ' ‚Ç´'">0 ‚Ç´</span>
                        </div>
                        <div class="text-muted small mb-3" id="shippingNote" style="display: none;">
                            Freeship cho s·∫£n ph·∫©m FW24
                        </div>

                        <hr class="summary-divider">

                        <div class="summary-total d-flex justify-content-between mb-3">
                            <div>
                                <strong>T·ªïng ti·ªÅn thanh to√°n</strong><br>
                                <small class="text-muted">(ƒê√£ bao g·ªìm thu·∫ø VAT)</small>
                            </div>
                            <strong class="total-amount" id="tongThanhToanText" th:text="${tongThanhToan} + ' ‚Ç´'">0
                                ‚Ç´</strong>
                        </div>

                        <div class="text-danger small mb-4" id="savingsText">
                            Ti·∫øt ki·ªám <span id="tienGiamText"
                                th:text="${#numbers.formatDecimal(tienGiam,0,'COMMA',0,'POINT')} + ' ‚Ç´'">0 ‚Ç´</span>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" form="checkout-form" class="btn btn-secondary btn-lg text-white">
                                THANH TO√ÅN
                            </button>
                            <a th:href="@{/gio-hang/hien_thi}" class="btn btn-outline-secondary">
                                ‚Üê Quay l·∫°i gi·ªè h√†ng
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function () {
            // Khai b√°o ph·∫ßn t·ª≠
            const phieuGiamGia = document.getElementById("phieuGiamGia");
            const tienGiamText = document.getElementById("tienGiamText");
            const tongThanhToanText = document.getElementById("tongThanhToanText");
            const provinceSelect = document.querySelector('select[name="provinceId"]');
            const districtSelect = document.querySelector('select[name="districtId"]');
            const wardSelect = document.querySelector('select[name="wardId"]');
            const shippingFeeText = document.getElementById("tienVanChuyenText");
            const shippingFeeInput = document.getElementById("tienVanChuyenInput");

            // C√°c input hidden l∆∞u t√™n ƒë·ªãa ch·ªâ
            const tenTinhHidden = document.getElementById("tenTinhHidden");
            const tenHuyenHidden = document.getElementById("tenHuyenHidden");
            const tenXaHidden = document.getElementById("tenXaHidden");

            // Discount dropdown elements
            const discountToggle = document.getElementById('discountToggle');
            const discountDropdown = document.getElementById('discountDropdown');
            const discountText = document.getElementById('discountText');

            // T·ªïng ti·ªÅn g·ªëc t·ª´ server
            const tongTien = /*[[${tongTien}]]*/ 0;
            let currentDiscount = 0;
            let currentShippingFee = 0;

            function updateTotalPay() {
                const total = tongTien - currentDiscount + currentShippingFee;
                tongThanhToanText.innerText = total.toLocaleString('vi-VN') + " ‚Ç´";
            }

            function clearSelect(select, placeholder = "-- Ch·ªçn --") {
                if (!select) return;
                select.innerHTML = `<option value="">${placeholder}</option>`;
            }

            function populateSelect(select, items, valueKey, textKey) {
                if (!select) return;
                clearSelect(select);
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item[valueKey];
                    option.textContent = item[textKey];
                    select.appendChild(option);
                });
            }

            // M√£ gi·∫£m gi√° - t√≠nh to√°n ti·ªÅn gi·∫£m
            phieuGiamGia.addEventListener("change", function () {
                const maPhieu = this.value;
                document.getElementById("phieuGiamGiaHidden").value = maPhieu;
                if (!maPhieu) {
                    currentDiscount = 0;
                    tienGiamText.innerText = "0 ‚Ç´";
                    document.getElementById("tienGiamInput").value = 0;
                    updateTotalPay();
                    return;
                }

                fetch(`/gio-hang/phieu-giam-gia/tien-giam?maPhieu=${maPhieu}&tongTien=${tongTien}`)
                    .then(res => res.json())
                    .then(tienGiam => {
                        currentDiscount = tienGiam;
                        tienGiamText.innerText = tienGiam.toLocaleString('vi-VN') + " ‚Ç´";
                        document.getElementById("tienGiamInput").value = tienGiam;
                        updateTotalPay();
                    })
                    .catch(() => {
                        currentDiscount = 0;
                        tienGiamText.innerText = "0 ‚Ç´";
                        document.getElementById("tienGiamInput").value = 0;
                        updateTotalPay();
                    });
            });

            // Khi ch·ªçn t·ªânh
            provinceSelect.addEventListener("change", function () {
                const provinceId = this.value;
                const selectedText = this.options[this.selectedIndex]?.text || "";
                tenTinhHidden.value = selectedText;

                clearSelect(districtSelect, "-- Ch·ªçn Qu·∫≠n / Huy·ªán --");
                clearSelect(wardSelect, "-- Ch·ªçn Ph∆∞·ªùng / X√£ --");
                tenHuyenHidden.value = "";
                tenXaHidden.value = "";

                currentShippingFee = 0;
                shippingFeeText.innerText = "0 ‚Ç´";
                shippingFeeInput.value = 0;
                updateTotalPay();

                if (!provinceId) return;

                fetch(`/gio-hang/thanh-toan/location?provinceId=${provinceId}`)
                    .then(res => res.json())
                    .then(districts => populateSelect(districtSelect, districts, 'DistrictID', 'DistrictName'))
                    .catch(err => console.error('L·ªói l·∫•y districts:', err));
            });

            // Khi ch·ªçn qu·∫≠n/huy·ªán
            districtSelect.addEventListener("change", function () {
                const districtId = this.value;
                const selectedText = this.options[this.selectedIndex]?.text || "";
                tenHuyenHidden.value = selectedText;

                clearSelect(wardSelect, "-- Ch·ªçn Ph∆∞·ªùng / X√£ --");
                tenXaHidden.value = "";

                currentShippingFee = 0;
                shippingFeeText.innerText = "0 ‚Ç´";
                shippingFeeInput.value = 0;
                updateTotalPay();

                if (!districtId) return;

                fetch(`/gio-hang/thanh-toan/location?districtId=${districtId}`)
                    .then(res => res.json())
                    .then(wards => populateSelect(wardSelect, wards, 'WardCode', 'WardName'))
                    .catch(err => console.error('L·ªói l·∫•y wards:', err));
            });

            // Khi ch·ªçn ph∆∞·ªùng/x√£
            wardSelect.addEventListener("change", function () {
                const wardCode = this.value;
                const selectedText = this.options[this.selectedIndex]?.text || "";
                tenXaHidden.value = selectedText;

                updateShippingFee();
            });

            function updateShippingFee() {
                const districtId = districtSelect?.value;
                const wardCode = wardSelect?.value;

                if (!districtId || !wardCode) {
                    currentShippingFee = 0;
                    shippingFeeText.innerText = "0 ‚Ç´";
                    shippingFeeInput.value = 0;
                    updateTotalPay();
                    return;
                }

                fetch(`/gio-hang/thanh-toan/shipping-fee?districtId=${districtId}&wardCode=${wardCode}`)
                    .then(res => {
                        if (!res.ok) throw new Error("Kh√¥ng th·ªÉ l·∫•y ph√≠ v·∫≠n chuy·ªÉn");
                        return res.json();
                    })
                    .then(fee => {
                        currentShippingFee = fee;
                        shippingFeeText.innerText = fee.toLocaleString('vi-VN') + " ‚Ç´";
                        shippingFeeInput.value = fee;
                        updateTotalPay();
                    })
                    .catch(err => {
                        console.error("L·ªói t√≠nh ph√≠ ship:", err);
                        currentShippingFee = 0;
                        shippingFeeText.innerText = "Kh√¥ng th·ªÉ t√≠nh";
                        shippingFeeInput.value = 0;
                        updateTotalPay();
                    });
            }

            // Kh·ªüi t·∫°o l·∫ßn ƒë·∫ßu
            tienGiamText.innerText = "0 ‚Ç´";
            shippingFeeText.innerText = "0 ‚Ç´";
            tongThanhToanText.innerText = tongTien.toLocaleString('vi-VN') + " ‚Ç´";

            function autoSelectBestVoucher() {
                const currentValue = phieuGiamGia.value;
                if (currentValue) return; // ƒê√£ c√≥ m√£ ƒë∆∞·ª£c ch·ªçn => kh√¥ng auto n·ªØa

                const options = [...phieuGiamGia.options].filter(o => o.value !== "");
                if (options.length === 0) return;

                let bestVoucher = null;
                let maxDiscount = 0;

                const promises = options.map(option => {
                    const maPhieu = option.value;
                    return fetch(`/gio-hang/phieu-giam-gia/tien-giam?maPhieu=${maPhieu}&tongTien=${tongTien}`)
                        .then(res => res.json())
                        .then(discount => {
                            if (discount > maxDiscount) {
                                maxDiscount = discount;
                                bestVoucher = maPhieu;
                            }
                        }).catch(() => { });
                });

                Promise.all(promises).then(() => {
                    if (bestVoucher) {
                        phieuGiamGia.value = bestVoucher;
                        phieuGiamGia.dispatchEvent(new Event('change'));
                    }
                });
            }

            autoSelectBestVoucher();
            // N·∫øu ƒë√£ c√≥ m√£ gi·∫£m gi√° ƒë∆∞·ª£c ch·ªçn s·∫µn t·ª´ server
            if (phieuGiamGia.value) {
                phieuGiamGia.dispatchEvent(new Event('change'));
                // C·∫≠p nh·∫≠t text hi·ªÉn th·ªã
                const selectedOption = phieuGiamGia.options[phieuGiamGia.selectedIndex];
                if (selectedOption) {
                    discountText.textContent = selectedOption.textContent.split(' - ')[0];
                }
            }

            // Payment method selection
            const paymentCards = document.querySelectorAll('.payment-card');
            const paymentInputs = document.querySelectorAll('input[name="phuongThucThanhToan"]');

            paymentInputs.forEach(input => {
                input.addEventListener('change', function () {
                    paymentCards.forEach(card => card.classList.remove('selected'));
                    if (this.checked) {
                        this.closest('.payment-card').classList.add('selected');
                    }
                });
            });

            // Discount dropdown toggle

            discountToggle.addEventListener('click', function (e) {
                e.preventDefault();
                const isVisible = discountDropdown.style.display !== 'none';
                discountDropdown.style.display = isVisible ? 'none' : 'block';
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function (e) {
                if (!discountToggle.contains(e.target) && !discountDropdown.contains(e.target)) {
                    discountDropdown.style.display = 'none';
                }
            });

            // Update discount text when selection changes
            phieuGiamGia.addEventListener('change', function () {
                const selectedOption = this.options[this.selectedIndex];
                if (this.value) {
                    discountText.textContent = selectedOption.textContent.split(' - ')[0]; // Show only code
                    discountDropdown.style.display = 'none';
                } else {
                    discountText.textContent = 'Ch·ªçn ho·∫∑c nh·∫≠p m√£';
                }
            });

            // Form validation and submission
            const checkoutForm = document.getElementById('checkout-form');
            const submitButton = checkoutForm.querySelector('button[type="submit"]');

            checkoutForm.addEventListener('submit', function (e) {
                e.preventDefault();

                // Basic validation
                const requiredFields = checkoutForm.querySelectorAll('[required]');
                let isValid = true;

                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        isValid = false;
                        field.classList.add('is-invalid');
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });

                // Check if payment method is selected
                const paymentMethod = checkoutForm.querySelector('input[name="phuongThucThanhToan"]:checked');
                if (!paymentMethod) {
                    isValid = false;
                    alert('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n');
                    return;
                }

                if (isValid) {
                    // Submit form
                    checkoutForm.submit();
                } else {
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
                }
            });
        });
    </script>

    <!-- Thong bao -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const successMsg = /*[[${success}]]*/ null;
        const errorMsg = /*[[${error}]]*/ null;

        function showCustomToast(type, message) {
            const toastId = type === 'success' ? 'customSuccess' : 'customError';
            const toastEl = document.getElementById(toastId);
            const msgEl = document.getElementById(type === 'success' ? 'successMsg' : 'errorMsg');
            const progressBar = toastEl.querySelector('.progress-bar');

            msgEl.textContent = message;
            toastEl.style.display = 'block';

            // Kh·ªüi ƒë·ªông l·∫°i animation n·∫øu toast ƒë∆∞·ª£c hi·ªÉn th·ªã l·∫°i
            progressBar.style.animation = 'none';
            void progressBar.offsetWidth; // force reflow
            progressBar.style.animation = null;

            // Auto close sau 4s
            setTimeout(() => {
                toastEl.style.display = 'none';
            }, 4000);
        }

        function closeToast(toastId) {
            const toastEl = document.getElementById(toastId);
            toastEl.style.display = 'none';
        }

        document.addEventListener("DOMContentLoaded", function () {
            if (successMsg && successMsg !== "null") showCustomToast('success', successMsg);
            if (errorMsg && errorMsg !== "null") showCustomToast('error', errorMsg);
        });
        /*]]>*/
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>